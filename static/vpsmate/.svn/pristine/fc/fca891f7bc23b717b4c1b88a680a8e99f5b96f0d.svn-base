var FileCtrl=["$scope","$routeParams","Module","Message","Request","Backend",function(o,e,m,l,p,d){var i="file";m.init(i,"文件管理");var a=e.path;var f=e.file;var c=true;var r=true;o.path=o.lastpath="/root";o.curpath="";o.showhidden=false;o.clipboard={srcpath:"",count:0,items:{}};o.confirm=o.cancel=function(){};var k=function(){var v=o.curpath.split("/");var u=[];for(var s=1;s<v.length;s++){if(!v[s]){continue}var t=v[s-1]+"/"+v[s];u.push({name:v[s],path:t});v[s]=t}o.pathinfos=u};o.loaded=false;o.load=function(){if(a||f){o.loaded=true;c=false;r=false;if(f){a=f.split("/");f=a.pop();a=a.join("/");if(!a){a="/"}}o.listdir(a,true,function(){if(f){o.editfile(f)}})}else{p.post("/operation/file",{action:"last"},function(u){if(u.code==0){o.loaded=true;var s=u.data.lastfile;var t=u.data.lastdir;o.listdir(t,true,function(){if(s&&s.indexOf(t)===0){s=s.replace(t+"/","");if(s.indexOf("/")==-1){o.editfile(s)}}})}},false,true)}};o.listdir=function(u,s,t){if(u){o.path=u}if(o.path==""){o.path="/root"}else{if(o.path!="/"&&o.path.substr(-1)=="/"){o.path=o.path.substr(0,o.path.length-1)}}o.path=o.path.replace("//","/");var v=o.path;p.post("/operation/file",{action:"listdir",path:v,showhidden:o.showhidden,remember:c},function(w){if(w.code==0){o.items=w.data;o.curpath=v;o.lastpath=v;if(s){o.selects={};o.selectall=false}}else{o.path=o.lastpath}k();if(t){t.call()}},false,true)};o.getitem=function(s,t){if(!t){t=s}else{delete o.selects[t]}p.post("/operation/file",{action:"getitem",path:o.curpath+"/"+s},function(z){if(z.code==0){var v=z.data;var y=false;for(var u=0;u<o.items.length;u++){if(o.items[u].name==t){o.items[u]=v;y=true;break}}if(!y){var w=false;var u=0;if(v.isdir||v.islnk&&v.link_isdir){for(;u<o.items.length;u++){var x=o.items[u];if(x.isdir||x.islnk&&x.link_isdir){if(o.items[u].name.localeCompare(v.name)>1){o.items.splice(u,0,v);w=true;break}}else{break}}}else{for(;u<o.items.length;u++){var x=o.items[u];if(x.isdir||x.islnk&&x.link_isdir){continue}if(o.items[u].name.localeCompare(v.name)>1){o.items.splice(u,0,v);w=true;break}}}if(!w){o.items.splice(u,0,v)}}}else{for(var u=0;u<o.items.length;u++){if(o.items[u].name==s){o.items.splice(u,1);break}}}},false,true)};o.upandlist=function(){var s=o.curpath.split("/");s.pop();o.listdir(s.join("/")+"/",true)};o.editfile=function(s){p.post("/operation/file",{action:"fread",path:o.curpath+"/"+s,remember:r},function(u){if(u.code==0){l.setSuccess("");var t=u.data;o.filename=t.filename;o.filepath=t.filepath;o.filecharset=t.charset;o.filecharset_org=t.charset;g.setValue("");$("#list").hide();$("#edit").show();g.setOption("mode",t.mimetype);g.setValue(t.content);n=false}})};o.return2list=o.canceledit=function(){if(n){o.confirm_title="是否放弃修改？";o.confirm_body=o.filepath+" 已被修改，是否放弃修改？";$("#confirm").modal();o.cancel=function(){};o.confirm=function(){$("#edit").hide();$("#list").show();p.post("/operation/file",{action:"fclose"},false,false,true)}}else{$("#edit").hide();$("#list").show();p.post("/operation/file",{action:"fclose"},false,false,true)}};o.savefile=function(){if(!n&&o.filecharset==o.filecharset_org){l.setInfo("文件未修改，无须保存！");return}p.post("/operation/file",{action:"fwrite",path:o.filepath,charset:o.filecharset,content:g.getValue()},function(s){if(s.code==0){n=false;o.getitem(o.filename)}})};o.newfolder=function(){o.newname_title="新建文件夹";o.newname_label="文件夹名称";o.newname_name="";$("#newname").modal();o.newname=function(){p.post("/operation/file",{action:"createfolder",path:o.curpath,name:o.newname_name},function(s){if(s.code==0){o.getitem(o.newname_name)}})}};o.newfile=function(){o.newname_title="新建文件";o.newname_label="文件名称";o.newname_name="";$("#newname").modal();o.newname=function(){p.post("/operation/file",{action:"createfile",path:o.curpath,name:o.newname_name},function(s){if(s.code==0){o.getitem(o.newname_name)}})}};o.upload=function(){$("#upload").modal()};o.doupload=function(){var s=$("#uploadform").find("input[name=ufile]").val().split(/[\\\/]/);var t=s[s.length-1];p.post("/operation/file",{action:"getitem",path:o.curpath+"/"+t},function(u){if(u.code==0){o.confirm_title="上传文件覆盖确认";o.confirm_body="<p>系统检测到当前目录下已存在同名文件 "+t+"。</p><p>确认要覆盖这个文件吗？</p>";$("#confirm").modal();o.confirm=function(){$("#uploadform").submit()}}else{$("#uploadform").submit()}},false,true)};o.download=function(){$("#download").modal();o.dodownload=function(){d.call(o,i,"/backend/wget","/backend/wget_"+encodeURIComponent(encodeURIComponent(o.downloadurl)),{url:o.downloadurl,path:o.curpath},{success:function(s){o.listdir()}})}};o.togglehidden=function(){o.showhidden=!o.showhidden;o.listdir()};o.rename=function(s){o.newname_title="重命名";o.newname_label="新名称";o.newname_name=s;$("#newname").modal();o.newname=function(){p.post("/operation/file",{action:"rename",path:o.curpath+"/"+s,name:o.newname_name},function(t){if(t.code==0){o.getitem(o.newname_name,s)}})}};var q=function(s){return function(u,v){var t=o.clipboard;if(t.srcpath!=o.curpath){t.items={};t.count=0}if(typeof v=="undefined"){if(typeof t.items[u]=="undefined"){t.srcpath=o.curpath;t.items[u]=s;t.count++}else{if(t.items[u]==s){delete t.items[u];t.count--}else{if(typeof v=="undefined"){t.items[u]=s}}}}else{if(v){if(typeof t.items[u]=="undefined"){t.srcpath=o.curpath;t.count++}t.items[u]=s}else{if(typeof t.items[u]!="undefined"){delete t.items[u];t.count--}}}}};o.togglecopy=q("copy");o.togglecut=q("cut");o.togglelink=q("link");o.paste=function(){h()};var b=function(v,u,s,t){if(v=="copy"){d.call(o,i,"/backend/copy","/backend/copy_"+u+"_"+s,{srcpath:u,despath:s},{success:function(w){delete o.clipboard.items[t];o.listdir();h()},error:function(w){o.listdir()}})}else{if(v=="cut"){d.call(o,i,"/backend/move","/backend/move_"+u+"_"+s,{srcpath:u,despath:s},{success:function(w){delete o.clipboard.items[t];o.listdir();h()},error:function(w){o.listdir()}})}else{if(v=="link"){p.post("/operation/file",{action:"link",srcpath:u,despath:s},function(w){if(w.code==0){o.listdir();delete o.clipboard.items[t];h()}})}}}};var h=function(t){var s="";for(s in o.clipboard.items){break}if(!s){return}var u=o.clipboard.items[s];p.post("/operation/file",{action:"exist",name:t?t:s,path:o.curpath},function(x){if(x.code==0){var w=o.clipboard.srcpath+"/"+s;var v=o.curpath+"/"+(t?t:s);if(x.data){o.overwrite_filename=(t?t:s);o.overwrite_option="rename";o.overwrite_newname=(t?t:s)+".new";$("#overwriteconfirm").modal();o.overwrite=function(){if(o.overwrite_option=="rename"){h(o.overwrite_newname)}else{b(u,w,v,s)}}}else{b(u,w,v,s)}}})};o.move2trash=function(s){p.post("/operation/file",{action:"delete",paths:o.curpath+"/"+s},function(v){if(v.code==0){o.getitem(s);var u="."+s+".bak";for(var t=0;t<o.items.length;t++){if(o.items[t].name==u){o.getitem(u);break}}}})};o.compressconfirm=function(s,t){o.compress_isreg=t;o.compress_type=t?".gz":".tar.gz";o.compress_zipname=s;o.compress_name=s;o.compress_names=[];$("#compressconfirm").modal()};o.compress=function(){var t=o.curpath+"/"+o.compress_zipname+o.compress_type;var s=o.curpath+"/"+o.compress_name;d.call(o,i,"/backend/compress","/backend/compress_"+t+"_"+s,{zippath:t,paths:s},{success:function(v){var u=o.compress_zipname+o.compress_type;if(o.compress_type==".gz"){o.getitem(u,o.compress_name)}else{o.getitem(u)}}})};o.decompress=function(t){var u=t.split(".");var s=u.pop();var w=u.pop();if(s=="gz"&&w!="tar"){var v=o.curpath+"/"+t;d.call(o,i,"/backend/decompress","/backend/decompress_"+v+"_",{zippath:v},{success:function(x){o.getitem(t.substr(0,t.length-3),t)}});return}o.selector_title="请选择要解压到的目录";o.selector.onlydir=true;o.selector.onlyfile=false;o.selector.load(o.curpath);o.selector.selecthandler=function(x){$("#selector").modal("hide");l.setInfo("正在检测目录...",true);p.post("/operation/file",{action:"listdir",path:x,showhidden:true,remember:false},function(z){if(z.code==0){l.setInfo("");var y=function(){var A=o.curpath+"/"+t;d.call(o,i,"/backend/decompress","/backend/decompress_"+A+"_"+x,{zippath:A,despath:x},{success:function(B){if(o.curpath==x){o.listdir()}}})};if(z.data.length>0){o.confirm_title="解压确认";o.confirm_body="<p>系统检测到目录 "+x+" 下存在文件，继续解压将可能覆盖这些文件。</p><p>确认要继续解压吗？</p>";$("#confirm").modal();o.confirm=y}else{y()}}else{l.setError("检测目录失败！")}},false,true)};$("#selector").modal()};o.$watch("selectall",function(s){angular.forEach(o.items,function(t){o.selects[t.name]=s})});o.multicopy=function(){angular.forEach(o.selects,function(s,t){o.togglecopy(t,s)})};o.multicut=function(){angular.forEach(o.selects,function(s,t){o.togglecut(t,s)})};o.multidel=function(){var s=[];angular.forEach(o.selects,function(t,u){if(t){s.push(o.curpath+"/"+u)}});if(s.length==0){return}p.post("/operation/file",{action:"delete",paths:s.join(",")},function(t){if(t.code==0){o.listdir()}})};o.tarconfirm=function(){var s=[];angular.forEach(o.selects,function(t,u){if(t){s.push(u)}});if(s.length==0){return}if(s.length==1){o.compressconfirm(s[0],false);return}o.compress_isreg=false;o.compress_type=".tar.gz";o.compress_zipname=o.curpath.split("/").pop();o.compress_name="多个项目";o.compress_names=s;$("#compressconfirm").modal()};o.tar=function(){var u=o.curpath+"/"+o.compress_zipname+o.compress_type;var t=[];for(var s=0;s<o.compress_names.length;s++){t.push(o.curpath+"/"+o.compress_names[s])}d.call(o,i,"/backend/compress","/backend/compress_"+u+"_"+t.join(","),{zippath:u,paths:t.join(",")},{success:function(v){o.listdir()}})};o.chownconfirm=function(u,t,w,s){if(!u){var v=[];angular.forEach(o.selects,function(x,y){if(x){v.push(y)}});if(v.length==0){return}}if(!o.users){p.post("/operation/user",{action:"listuser",fullinfo:false},function(x){if(x.code==0){o.users=x.data}},false,true)}if(!o.groups){p.post("/operation/user",{action:"listgroup",fullinfo:false},function(x){if(x.code==0){o.groups=x.data}},false,true)}if(u){o.chown_user=t;o.chown_group=w;o.chown_names=[u];o.chown_recursively=true;o.chown_hasdir=s}else{o.chown_names=v;o.chown_recursively=true;o.chown_hasdir=true}$("#chownconfirm").modal()};o.chown=function(){var t=[];for(var s=0;s<o.chown_names.length;s++){t.push(o.curpath+"/"+o.chown_names[s])}t=t.join(",");d.call(o,i,"/backend/chown","/backend/chown_"+t,{paths:t,user:o.chown_user,group:o.chown_group,recursively:o.chown_recursively},{success:function(u){if(o.chown_names.length==1){o.getitem(o.chown_names[0])}else{o.listdir()}}})};o.chmodconfirm=function(t,u,s){if(!t){var v=[];angular.forEach(o.selects,function(w,x){if(w){v.push(x)}});if(v.length==0){return}u="0744"}u=parseInt(u,8);o.chmod_permbits=[[(u&256)!=0,(u&128)!=0,(u&64)!=0],[(u&32)!=0,(u&16)!=0,(u&8)!=0],[(u&4)!=0,(u&2)!=0,(u&1)!=0],];o.chmod_recursively=true;if(t){o.chmod_names=[t];o.chmod_hasdir=s}else{o.chmod_names=v;o.chmod_hasdir=true}$("#chmodconfirm").modal()};o.chmod=function(){var u=0;for(var t=0;t<3;t++){for(var s=0;s<3;s++){u|=(o.chmod_permbits[t][s]<<(8-t*3-s))}}u=u.toString(8);var v=[];for(var t=0;t<o.chmod_names.length;t++){v.push(o.curpath+"/"+o.chmod_names[t])}v=v.join(",");d.call(o,i,"/backend/chmod","/backend/chmod_"+v,{paths:v,perms:u,recursively:o.chmod_recursively},{success:function(w){if(o.chmod_names.length==1){o.getitem(o.chmod_names[0])}else{o.listdir()}}})};var n=false;var g=CodeMirror(document.getElementById("editor"),{value:"",lineNumbers:true,lineWrapping:true,matchBrackets:true,onCursorActivity:function(){g.setLineClass(j,null,null);j=g.setLineClass(g.getCursor().line,null,"activeline");if(!$.browser.msie){g.matchHighlight("CodeMirror-matchhighlight")}},onChange:function(){n=true}});var j=g.setLineClass(0,"activeline")}];var FileTrashCtrl=["$scope","$routeParams","Module","Message","Request","Backend",function(c,a,g,f,e,b){var d="file.trash";g.init(d,"回收站管理");c.loaded=true;c.confirm=function(){};c.tlist=function(){e.post("/operation/file",{action:"tlist"},function(h){if(h.code==0){c.items=h.data}})};c.restore=function(h,i){e.post("/operation/file",{action:"trestore",mount:h,uuid:i},function(j){if(j.code==0){c.tlist()}})};c.tdeleteconfirm=function(i,h,j){c.confirm_title="删除确认";c.confirm_body="<p>删除后文件将不可恢复！</p><p>确认要删除 "+i+" 吗？</p>";$("#confirm").modal();c.confirm=function(){c.tdelete(h,j)}};c.tdelete=function(h,i){e.post("/operation/file",{action:"titem",mount:h,uuid:i},function(j){if(j.code==0){var k=j.data.realpath;b.call(c,d,"/backend/remove","/backend/remove_"+k,{paths:k},function(){e.post("/operation/file",{action:"tdelete",mount:h,uuid:i},function(l){if(l.code==0){c.tlist()}})})}})};c.tcleanconfirm=function(){c.confirm_title="清空确认";c.confirm_body="<p>清空回收站后，回收站中的所有文件都将被删除且不可恢复！<p>								<p>确认要清空回收站吗？</p>";$("#confirm").modal();c.confirm=function(){c.tclean()}};c.tclean=function(){e.post("/operation/file",{action:"trashs"},function(h){if(h.code==0){var i=h.data.join(",");b.call(c,d,"/backend/remove","/backend/remove_"+i,{paths:i},function(){f.setSuccess("清空回收站完成！");c.tlist()})}})}}];