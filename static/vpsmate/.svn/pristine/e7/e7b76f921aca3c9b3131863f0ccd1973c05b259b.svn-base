angular.module("vpsmate.services",[]).factory("Auth",["$rootScope","$http","$location",function(a,d,c){var b={};b.required=function(f,e){d.post("/authstatus").success(function(g){if(f){f.call(null,g.authed=="yes")}if(g.authed=="no"){a.loginto=c.path();if(a.loginto=="/"||a.loginto=="/logout"){a.loginto="/main"}c.path("/")}}).error(function(h,g){if(e){e.call(null,g)}})};b.getlastactive=function(e){d.get("/authstatus?"+Math.random()).success(function(f){if(e){e.call(null,f.lastactive)}})};return b}]).factory("Module",["$rootScope","$location",function(a,c){var b={};b.init=function(e,d){a.module=e;a.htmlTitle=d};b.initSection=function(d){var e=c.search().s;a.activeTabName=e?e:d};b.getSection=function(){return c.search().s};b.setSection=function(d){a.activeTabName=d};b.getParam=function(d){return c.search()[d]};return b}]).factory("Timeout",["$rootScope","$timeout",function(a,b){var c=function(h,g,f,d,e){if(f&&a.module!=f){return}if(d&&a[e]){return}if(!e){e="timeout"}a[e]=b(function(){if(a[e]){delete a[e]}if(!f||a.module==f){h.call()}},g)};return c}]).factory("Message",["$rootScope","$timeout",function(a,c){var b={};a.showSuccessMsg=false;a.showErrorMsg=false;a.showWarningMsg=false;a.showInfoMsg=false;a.msgTimeout=0;var d=function(){if(a.msgTimeout){c.cancel(a.msgTimeout)}a.msgTimeout=c(function(){a.showSuccessMsg=false;a.showErrorMsg=false;a.showInfoMsg=false;a.msgTimeout=0},5000)};b.setSuccess=function(f,e){a.successMessage=f;if(f){a.showSuccessMsg=true;a.showErrorMsg=false;a.showInfoMsg=false;if(!e){d()}}else{a.showSuccessMsg=false;a.showErrorMsg=false;a.showInfoMsg=false}};b.setError=function(f,e){a.errorMessage=f;if(f){a.showSuccessMsg=false;a.showErrorMsg=true;a.showInfoMsg=false;if(!e){d()}}else{a.showSuccessMsg=false;a.showErrorMsg=false;a.showInfoMsg=false}};b.setInfo=function(f,e){a.infoMessage=f;if(f){a.showSuccessMsg=false;a.showErrorMsg=false;a.showInfoMsg=true;if(!e){d()}}else{a.showSuccessMsg=false;a.showErrorMsg=false;a.showInfoMsg=false}};b.setWarning=function(f,e){a.warningMessage=f;if(f){a.showWarningMsg=true;if(!e){d()}}else{a.showWarningMsg=false}};return b}]).factory("Request",["$http","$rootScope","$location","$timeout","Message",function(h,b,g,e,d){var c={};var f=function(j,i){return function(k){b.processing=false;if(!i&&k.msg){if(k.code==0){d.setSuccess(k.msg)}else{if(k.code==-1){d.setError(k.msg)}else{if(k.code==1){d.setWarning(k.msg)}else{if(k.code==2){d.setInfo(k.msg)}}}}}if(j){j.call(null,k)}}};var a=function(j,i){return function(l,k){b.processing=false;if(!i&&j){if(!j.call(null,l,k)){return}}if(k==403){d.setError("登录无效或超时，请重新登录。",true);g.path("/")}else{d.setError("发生未知错误！")}}};c.setProcessing=function(i){b.processing=i};c.get=function(k,m,l,j){b.processing=true;var i=b.$proxyroot+k;if(i.indexOf("?")>0){i+="&"+Math.random()}else{i+="?"+Math.random()}h.get(i).success(f(m,j)).error(a(l,j))};c.post=function(j,l,m,k,i){b.processing=true;h.post(b.$proxyroot+j,l).success(f(m,i)).error(a(k,i))};return c}]).factory("Backend",["Timeout","Request",function(c,b){var a={};a.call=function(d,g,f,j,h,i,e){d.waiting=true;b.post(d.$proxyroot+f,h,function(k){if(k.code==-1){if(i){if(typeof i.error=="function"){i.error.call(null,k.data)}}return}var l=function(){b.get(j,function(m){if(m.status=="finish"){d.waiting=false;if(m.code==0){if(i){if(typeof i=="function"){i.call(null,m)}else{if(typeof i.success=="function"){i.success.call(null,m)}}}}else{if(i){if(typeof i=="function"){i.call(null,m)}else{if(typeof i.error=="function"){i.error.call(null,m)}}}}}else{if(i){if(typeof i.wait=="function"){i.wait.call(null,m)}}c(l,500,g)}},false,e)};c(l,500,g)},function(k){if(i){if(typeof i.error=="function"){i.error.call(null,k)}}})};return a}]);var LoginCtrl=["$scope","$rootScope","$location","Module","Message","Request",function(b,a,h,f,e,d){var c="login";f.init(c,"登录");b.loginText="登录";b.showForgetPwdMsg=false;b.showLoginForm=true;b.username="";b.password="";var g=function(m){var l=new RegExp("^(?=.{8,})(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*\\W).*$","g");var k=new RegExp("^(?=.{7,})(((?=.*[A-Z])(?=.*[a-z]))|((?=.*[A-Z])(?=.*[0-9]))|((?=.*[a-z])(?=.*[0-9]))).*$","g");var j=new RegExp("(?=.{6,}).*","g");if(false==j.test(m)){return"无安全性可言"}else{if(l.test(m)){return"高"}else{if(k.test(m)){return"一般"}else{return"低"}}}};b.login=function(j){b.loginText="登录中...";d.post("/login",{username:b.username,password:j?b.password:hex_md5(b.password)},function(k){if(k.code>=0){b.showLoginForm=false;var l=a.loginto?a.loginto:"/main";if(k.code==0){h.path(l)}else{b.pwdStrength=g(b.password);if(b.pwdStrength!="高"){e.setError(false);e.setWarning(false);$("#main").hide();b.loginMessage=k.msg;b.loginWarning=true}else{h.path(l)}}}else{b.loginText="登录"}})}}];var LogoutCtrl=["$scope","$location","Module","Request","Timeout",function(a,f,d,c,e){var b="logout";d.init(b,"退出登录");a.loaded=false;e(function(){a.loaded=true;c.get("/xsrf",function(){c.post("/logout",{},function(g){e(function(){f.path("/")},3000,b)})})},1000,b)}];var deepUpdate=function(a,b){for(i in b){if(typeof(b[i])=="object"){deepUpdate(a[i],b[i])}else{if(a[i]!=b[i]){a[i]=b[i]}}}};var MainCtrl=["$scope","$routeParams","$location","Module","Timeout","Request","version",function(c,a,h,f,g,e,b){var d="main";f.init(d,"首页");f.initSection("server");c.version=b;c.info=null;c.loaded=false;c.detectVer=true;c.hasNewver=false;e.get("/setting/upver",function(k){if(k.code==-1){c.upverMessage=k.msg}else{if(k.code==0){var j=k.data;if(parseFloat(j.version)>parseFloat(b.version)||(parseFloat(j.version)==parseFloat(b.version)&&parseInt(j.build)>parseInt(b.build))){c.detectVer=false;c.hasNewver=true}}}});c.checkUpdate=function(){h.path("/setting");h.search("s","upversion")};c.loadInfo=function(j){if(!j){j="*"}e.get("/query/"+j,function(r){if(c.info==null){c.info=r;c.info["server.cpustat"]["total"]["used_rate"]="获取中...";for(var p=0;p<r["server.netifaces"].length;p++){c.info["server.netifaces"][p]["rx_speed"]="0";c.info["server.netifaces"][p]["tx_speed"]="0"}if(!c.loaded){c.loaded=true}}else{if(c.info){var q=r["server.cpustat"]["total"];var k=c.info["server.cpustat"]["total"];var s=(q.used-k.used)/(q.all-k.all);s=Math.round(s*10000)*10;var o=100000-s;s=((s+1)/1000).toString();o=((o+1)/1000).toString();q.used_rate=s.substring(0,s.length-1)+"%";q.idle_rate=o.substring(0,o.length-1)+"%";var n=r["server.netifaces"];var l=c.info["server.netifaces"];for(var p=0;p<n.length;p++){var m=n[p]["timestamp"]-l[p]["timestamp"];if(m>0){n[p]["rx_speed"]=Math.round((n[p]["rx_bytes"]-l[p]["rx_bytes"])/m);n[p]["tx_speed"]=Math.round((n[p]["tx_bytes"]-l[p]["tx_bytes"])/m)}}}deepUpdate(c.info,r)}g(c.loadInfo,1000,d)})}}];var FtpCtrl=["$scope","Module",function(a,c){var b="ftp";c.init(b,"FTP管理");a.loaded=true}];var TaskCtrl=["$scope","Module",function(a,c){var b="task";c.init(b,"计划任务");a.loaded=true}];var SettingCtrl=["$scope","$routeParams","Module","Timeout","Message","Request","version",function(c,a,g,h,f,e,b){var d="setting";g.init(d,"系统设置");g.initSection("authinfo");c.version=b;c.showUpdateBtn=false;c.showRestartBtn=true;c.loaded=true;c.password=c.passwordc="";c.loadAuthInfo=function(){e.get("/setting/auth",function(j){c.username=j.username;c.passwordcheck=j.passwordcheck})};c.loadServerInfo=function(){e.get("/setting/server",function(j){c.ip=j.ip;c.port=j.port})};c.loadAccessKey=function(){e.get("/setting/accesskey",function(j){c.accesskey=j.accesskey;c.enableaccesskey=j.enableaccesskey})};c.updateAuthInfo=function(){e.post("/setting/auth",{username:c.username,password:c.password?hex_md5(c.password):"",passwordc:c.passwordc?hex_md5(c.passwordc):"",passwordcheck:c.passwordcheck},function(j){if(j.code==0){c.loadAuthInfo()}})};c.updateServerInfo=function(){e.post("/setting/server",{port:c.port,ip:c.ip},function(){if(data.code==0){c.loadServerInfo()}})};c.updateAccessKey=function(){e.post("/setting/accesskey",{accesskey:c.accesskey,enableaccesskey:c.enableaccesskey},function(j){if(j.code==0){c.loadAccessKey()}})};c.checkUpVersion=function(){c.upverMessage="正在检测新版本...";e.get("/setting/upver?force=1",function(k){if(k.code==-1){c.upverMessage=k.msg}else{if(k.code==0){var j=k.data;if(parseFloat(j.version)>parseFloat(b.version)||(parseFloat(j.version)==parseFloat(b.version)&&parseInt(j.build)>parseInt(b.build))){c.upverMessage='<table class="table table-condensed"><thead><tr><th colspan="2">有可用的新版本</th></tr></thead><tbody><tr><td>版本信息：</td><td>v'+j.version+" b"+j.build+"</td></tr><tr><td>发布时间：</td><td>"+j.releasetime+'</td></tr><tr><td>变更记录：</td><td><a href="'+j.changelog+'" target="_blank">查看版本变更记录</a></td></tr></tbody></table>';c.updateBtnText="开始在线升级";c.showUpdateBtn=true}else{c.upverMessage="当前已是最新版本！"}}}})};c.update=function(){c.upverMessage="正在升级，请稍候...";c.showUpdateBtn=false;e.post("/backend/update",{},function(k){var j=function(){e.get("backend/update",function(l){f.setInfo("");if(l.msg){c.upverMessage=l.msg}if(l.status=="finish"&&l.code==0){c.upverMessage="正在重启 VPSMate...";h(function(){e.post("/backend/service_restart",{service:"vpsmate"},function(n){var m=function(){e.get("backend/service_restart_vpsmate",function(o){f.setInfo("");if(o.msg){c.upverMessage=o.msg}h(m,500,d)},function(p,o){if(o==403||o==0){c.upverMessage="升级成功！请刷新页面重新登录。";return false}return true})};h(m,500,d)})},1000,d)}else{h(j,500,d)}})};h(j,500,d)})};c.restartMessage="是否要重启 VPSMate？";c.restart=function(){c.restartMessage="正在重启，请稍候...";c.showRestartBtn=false;h(function(){e.post("/backend/service_restart",{service:"vpsmate"},function(k){var j=function(){e.get("backend/service_restart_vpsmate",function(l){if(l.msg){c.restartMessage=l.msg}h(j,500,d)},function(m,l){if(l==403||l==0){c.restartMessage="重启成功！请刷新页面重新登录。";return false}return true})};h(j,500,d)})},1000,d)};c.genaccesskey=function(){var l="";for(var k=0;k<32;k++){l+=String.fromCharCode(Math.floor(256*Math.random()))}var j=function(p){var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o="";var v,t,s,w,u,r,q;var n=0;while(n<p.length){v=p.charCodeAt(n++);t=p.charCodeAt(n++);s=p.charCodeAt(n++);w=v>>2;u=((v&3)<<4)|(t>>4);r=((t&15)<<2)|(s>>6);q=s&63;if(isNaN(t)){r=q=64}else{if(isNaN(s)){q=64}}o=o+m.charAt(w)+m.charAt(u)+m.charAt(r)+m.charAt(q)}return o};c.accesskey=j(l)}}];var SorryCtrl=["$scope","Module","$timeout",function(a,d,c){var b="sorry";d.init(b,"页面不存在");a.loaded=true}];var DatabaseCtrl=["$scope","Module","$rootScope","Request","Message","Backend",function(c,g,a,f,e,b){var d="database";g.init(d,"数据库管理");c.loaded=false;var h=g.getSection();c.has_dbserver=false;c.mysql_supported=false;c.load=function(){f.get("/query/service.mysqld",function(i){if(i["service.mysqld"]&&i["service.mysqld"].status){c.mysql_supported=true}c.has_dbserver=c.mysql_supported;if(c.has_dbserver){if(h){if(h=="mysqld"&&c.mysql_supported){g.setSection("mysqld")}else{g.setSection(c.mysql_supported?"mysql":"mysql")}}else{g.setSection(c.mysql_supported?"mysql":"mysql")}}c.loaded=true})};c.validate_password=function(){c.processing=true;f.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true;c.loaddbs();c.loadusers()}c.processing=false})};c.dbloading=true;c.loaddbs=function(){c.dbloading=true;b.call(c,d,"/backend/mysql_databases","/backend/mysql_databases",{password:a.$mysql.password},{success:function(i){c.dbs=i.data;c.dbloading=false},error:function(){c.dbloading=false}})};c.userloading=true;c.loadusers=function(){c.userloading=true;b.call(c,d,"/backend/mysql_users","/backend/mysql_users",{password:a.$mysql.password},{success:function(i){c.users=i.data;c.userloading=false},error:function(){c.userloading=false}})};if(a.$mysql.password_validated){c.loaddbs();c.loadusers()}}];var DatabaseMySQLNewDBCtrl=["$scope","Module","$rootScope","$location","Request","Message","Backend",function(c,g,a,h,f,e,b){var d="database.mysql.db.new";g.init(d,"新建数据库");c.loaded=true;c.collation="utf8_general_ci";c.validate_password=function(){c.processing=true;f.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true}c.processing=false})};c.newdb=function(){c.processing=true;b.call(c,d,"/backend/mysql_create","/backend/mysql_create_"+c.dbname,{password:a.$mysql.password,dbname:c.dbname,collation:c.collation},{success:function(i){h.path("/database/mysql/db/edit/"+encodeURIComponent(c.dbname));c.processing=false},error:function(){c.processing=false}})}}];var DatabaseMySQLEditDBCtrl=["$scope","Module","$rootScope","$routeParams","$location","Request","Message","Backend",function(j,b,g,i,d,f,a,c){var h=i.section;j.dbname=decodeURIComponent(h);var e="database.mysql.db.edit";b.init(e,"管理数据库 "+j.dbname);b.initSection("users");j.loaded=true;j.validate_password=function(){j.processing=true;f.post("/operation/mysql",{action:"checkpwd",password:g.$mysql.password},function(k){if(k.code==0){g.$mysql.password_validated=true;j.loaddbinfo()}j.processing=false})};j.dbloading=true;j.loaddbinfo=function(){j.dbloading=true;c.call(j,e,"/backend/mysql_dbinfo","/backend/mysql_dbinfo_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},{success:function(k){j.dbinfo=k.data;j.dbloading=false;j.loadusers()},error:function(){j.dbloading=false}})};j.userloading=true;j.loadusers=function(){j.userloading=true;c.call(j,e,"/backend/mysql_users","/backend/mysql_users_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},{success:function(k){j.users=k.data;j.userloading=false},error:function(){j.userloading=false}})};j.setcollation=function(){j.processing=true;f.post("/operation/mysql",{action:"alter_database",password:g.$mysql.password,dbname:j.dbname,collation:j.dbinfo.collation},function(){j.processing=false})};j.rename=function(){j.processing=true;c.call(j,e,"/backend/mysql_rename","/backend/mysql_rename_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname,newname:j.dbinfo.name},{success:function(k){d.path("/database/mysql/db/edit/"+encodeURIComponent(j.dbinfo.name));j.processing=false},error:function(){j.processing=false}})};j.selectexportfolder=function(){j.selector.onlydir=true;j.selector.onlyfile=false;j.selector.load(j.exportpath?j.exportpath:"/root");j.selector.selecthandler=function(k){$("#selector").modal("hide");j.exportpath=k};$("#selector").modal()};j.exportdb=function(){j.processing=true;c.call(j,e,"/backend/mysql_export","/backend/mysql_export_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname,path:j.exportpath},function(k){j.processing=false})};j.dropdb=function(){j.processing=true;c.call(j,e,"/backend/mysql_drop","/backend/mysql_drop_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},function(k){if(k.code==0){d.path("/database");d.search("s","mysql")}j.processing=false})};if(g.$mysql.password_validated){j.loaddbinfo()}}];var DatabaseMySQLNewUserCtrl=["$scope","Module","$rootScope","$location","Request","Message","Backend",function(c,g,a,h,f,e,b){var d="database.mysql.user.new";g.init(d,"添加新用户");c.loaded=true;c.dbname=g.getParam("dbname");c.validate_password=function(){c.processing=true;f.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true}c.processing=false})};c.newuser=function(){if(!c.emptypassword){if(c.password!=c.passwordc){e.setError("新密码和确认密码不一致！");return}}var i=c.user+"@"+c.host;c.processing=true;b.call(c,d,"/backend/mysql_createuser","/backend/mysql_createuser_"+i,{password:a.$mysql.password,user:c.user,host:c.host,pwd:c.emptypassword?"":c.password},{success:function(j){h.path("/database/mysql/user/edit/"+encodeURIComponent(i));if(c.dbname){h.search("dbname",c.dbname)}c.processing=false},error:function(){c.processing=false}})};c.genpassword=function(){var n="ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var o=16;var m="";var j=0;var p=0;for(var l=0;l<o;l++){if((Math.floor(Math.random()*2)==0)&&p<3||j>=5){var k=Math.floor(Math.random()*10);m+=k;p+=1}else{var k=Math.floor(Math.random()*n.length);m+=n.substring(k,k+1);j+=1}}c.randpassword=c.password=c.passwordc=m}}];var DatabaseMySQLEditUserCtrl=["$scope","Module","$rootScope","$routeParams","$location","Request","Message","Backend",function(k,b,h,j,d,g,a,c){var i=j.section;k.username=decodeURIComponent(i);var e=k.username.split("@");k.user=e[0];k.host=e[1];var f="database.mysql.user.edit";b.init(f,"管理用户 "+k.username);b.initSection("privs");k.loaded=true;k.validate_password=function(){k.processing=true;g.post("/operation/mysql",{action:"checkpwd",password:h.$mysql.password},function(m){if(m.code==0){h.$mysql.password_validated=true;k.loadprivs();k.loaddbs()}k.processing=false})};k.privsloading=true;k.loadprivs=function(){k.privsloading=true;c.call(k,f,"/backend/mysql_userprivs","/backend/mysql_userprivs_"+k.username,{password:h.$mysql.password,username:k.username},{success:function(m){k.privs=m.data;k.privsloading=false;var o=b.getParam("dbname");var n=b.getParam("privtype");if(o){k.privs_dbname=o;k.editprivs(false,n)}},error:function(){k.privsloading=false}})};k.$watch("selectall",function(m){angular.forEach(k.curprivs,function(n,o){if(o.indexOf("_priv")>0){k.curprivs[o]=m?"Y":"N"}})});var l={Select_priv:"N",Insert_priv:"N",Update_priv:"N",Delete_priv:"N",Create_priv:"N",Alter_priv:"N",Index_priv:"N",Drop_priv:"N",Create_tmp_table_priv:"N",Show_view_priv:"N",Create_routine_priv:"N",Alter_routine_priv:"N",Execute_priv:"N",Create_view_priv:"N",Event_priv:"N",Trigger_priv:"N",Grant_priv:"N",Lock_tables_priv:"N",References_priv:"N"};k.editprivs=function(p,o){if(o=="global"){k.orgprivs=k.privs.global;k.curprivs=angular.copy(k.privs.global)}else{if(!p){if(!k.privs_dbname){return}var n=false;for(var m=0;m<k.privs.bydb.length;m++){if(k.privs.bydb[m].Db==k.privs_dbname){k.orgprivs=k.privs.bydb[m];k.curprivs=angular.copy(k.privs.bydb[m]);n=true;break}}if(!n){k.orgprivs=null;k.curprivs=angular.copy(l);k.curprivs.Db=k.privs_dbname;k.curprivs.flag="new"}}else{k.orgprivs=p;k.curprivs=angular.copy(p)}}if(!k.curprivs.Db){k.privsedit_title="设置 "+k.username+" 的全局权限"}else{k.privsedit_title="设置 "+k.username+" 在数据库 "+k.curprivs.Db+" 的权限"}$("#privsedit").modal()};k.updateprivs=function(){c.call(k,f,"/backend/mysql_updateuserprivs","/backend/mysql_updateuserprivs_"+encodeURIComponent(k.username+(k.curprivs.Db?"_"+k.curprivs.Db:"")),{password:h.$mysql.password,username:k.username,privs:angular.toJson(k.curprivs),dbname:k.curprivs.Db},{success:function(m){if(k.curprivs.flag=="new"){k.privs.bydb.push(k.curprivs)}else{angular.copy(k.curprivs,k.orgprivs)}var n=b.getParam("dbname");if(n){d.path("/database/mysql/db/edit/"+encodeURIComponent(n))}}})};k.loaddbs=function(){k.dbloading=true;c.call(k,f,"/backend/mysql_databases","/backend/mysql_databases",{password:h.$mysql.password},{success:function(m){k.dbs=m.data}},true)};k.setpassword=function(){if(!k.emptypassword){if(k.newpassword!=k.newpasswordc){a.setError("新密码和确认密码不一致！");return}}k.processing=true;c.call(k,f,"/backend/mysql_setuserpassword","/backend/mysql_setuserpassword_"+k.username,{password:h.$mysql.password,username:k.username,pwd:k.emptypassword?"":k.newpassword},{success:function(m){k.processing=false},error:function(){k.processing=false}})};k.dropuser=function(){k.processing=true;c.call(k,f,"/backend/mysql_dropuser","/backend/mysql_dropuser_"+k.username,{password:h.$mysql.password,username:k.username},function(m){if(m.code==0){d.path("/database");d.search("s","mysql")}k.processing=false})};if(h.$mysql.password_validated){k.loadprivs();k.loaddbs()}}];var UtilsCtrl=["$scope","Module","Request",function(a,d,c){var b="utils";d.init(b,"系统工具");a.loaded=true;a.rebootconfirm=function(){$("#rebootconfirm").modal()};a.reboot=function(){c.post("/operation/reboot")}}];var UtilsUserCtrl=["$scope","$routeParams","Module","Timeout","Request",function(b,a,e,f,d){var c="utils.user";e.init(c,"用户管理");e.initSection("user");b.loaded=true;b.loadUsers=function(){d.post("/operation/user",{action:"listuser"},function(g){if(g.code==0){b.users=g.data}},false,true)};b.loadGroups=function(){d.post("/operation/user",{action:"listgroup"},function(g){if(g.code==0){b.groups=g.data}},false,true)};b.useraddconfirm=function(){b.curuser={pw_name:"",pw_gecos:"",pw_gname:"",pw_shell:"/bin/bash",pw_passwd:"",pw_passwdc:"",createhome:true,lock:false};$("#useraddconfirm").modal()};b.useradd=function(){var g=b.curuser;g.action="useradd";d.post("/operation/user",g,function(h){if(h.code==0){b.loadUsers();b.loadGroups()}})};b.usermodconfirm=function(h){var g=b.users[h];b.curuser={pw_name:g.pw_name,pw_gecos:g.pw_gecos,pw_gname:g.pw_gname,pw_dir:g.pw_dir,pw_shell:g.pw_shell,pw_passwd:"",pw_passwdc:"",lock:g.lock};$("#usermodconfirm").modal()};b.usermod=function(){var g=b.curuser;g.action="usermod";d.post("/operation/user",g,function(h){if(h.code==0){b.loadUsers();b.loadGroups()}})};b.userdelconfirm=function(h){var g=b.users[h];b.curuser={pw_name:g.pw_name};$("#userdelconfirm").modal()};b.userdel=function(){d.post("/operation/user",{action:"userdel",pw_name:b.curuser.pw_name},function(g){if(g.code==0){b.loadUsers();b.loadGroups()}})};b.groupaddconfirm=function(){b.curgrp_name="";$("#groupaddconfirm").modal()};b.groupadd=function(){d.post("/operation/user",{action:"groupadd",gr_name:b.curgrp_name},function(g){if(g.code==0){b.loadGroups()}})};b.groupmodconfirm=function(g){b.curgrp_newname=b.curgrp_name=b.groups[g].gr_name;$("#groupmodconfirm").modal()};b.groupmod=function(){d.post("/operation/user",{action:"groupmod",gr_name:b.curgrp_name,gr_newname:b.curgrp_newname},function(g){if(g.code==0){b.loadGroups()}})};b.groupdelconfirm=function(g){b.curgrp_name=b.groups[g].gr_name;$("#groupdelconfirm").modal()};b.groupdel=function(){d.post("/operation/user",{action:"groupdel",gr_name:b.curgrp_name},function(g){if(g.code==0){b.loadGroups()}})};b.groupmemsaddconfirm=function(g){b.curgrp_name=b.groups[g].gr_name;b.curgrp_mem="";$("#groupmemsaddconfirm").modal()};b.groupmemsadd=function(){d.post("/operation/user",{action:"groupmems_add",gr_name:b.curgrp_name,mem:b.curgrp_mem},function(g){if(g.code==0){b.loadUsers();b.loadGroups()}})};b.groupmemsdelconfirm=function(g){b.curgrp_name=b.groups[g].gr_name;b.curgrp_mems=b.groups[g].gr_mem;b.curgrp_mem="";$("#groupmemsdelconfirm").modal()};b.groupmemsdel=function(){d.post("/operation/user",{action:"groupmems_del",gr_name:b.curgrp_name,mem:b.curgrp_mem},function(g){if(g.code==0){b.loadUsers();b.loadGroups()}})}}];var UtilsNetworkCtrl=["$scope","$routeParams","Module","Timeout","Message","Request",function(b,a,f,g,e,d){var c="utils.network";f.init(c,"网络设置");f.initSection("ip");b.restartMessage="是否要重启网络？";b.loaded=true;b.showRestartBtn=true;b.loadIfNames=function(){d.get("/utils/network/ifnames",function(h){b.ifnames=h.ifnames;b.ifname=b.ifnames[0];b.loadIfConfig(b.ifname)})};b.loadIfConfig=function(h){b.ifname=h;d.get("/utils/network/ifconfig/"+h,function(i){b.ip=i.ip;b.mask=i.mask;b.gw=i.gw})};b.saveIfConfig=function(){d.post("/utils/network/ifconfig/"+b.ifname,{ip:b.ip,mask:b.mask,gw:b.gw},function(h){if(h.code==0){b.loadIfConfig(b.ifname)}})};b.loadNameservers=function(){d.get("/utils/network/nameservers",function(h){b.nameservers=h.nameservers})};b.saveNameservers=function(){var h=[];$(".nameserver").each(function(){var i=$(this).val();if(i){h.push(i)}});d.post("/utils/network/nameservers",{nameservers:h.join(",")},function(i){if(i.code==0){b.loadNameservers()}})};b.addNameserver=function(){b.nameservers.push("")};b.delNameserver=function(h){b.nameservers.splice(h,1)};b.restart=function(){b.restartMessage="正在重启，请稍候...";b.showRestartBtn=false;g(function(){d.post("/backend/service_restart",{service:"network"},function(i){var h=function(){d.get("backend/service_restart_network",function(j){if(j.msg){b.restartMessage=j.msg}if(j.status=="finish"){e.setSuccess("");g(function(){b.restartMessage="是否要重启网络？";b.showRestartBtn=true},3000,c)}else{g(h,500,c)}})};g(h,500,c)})},1000,c)}}];var UtilsTimeCtrl=["$scope","$routeParams","Module","Timeout","Request","Backend",function(j,i,b,d,f,c){var e="utils.time";b.init(e,"时间设置");b.initSection("datetime");j.loaded=true;j.loadDatetime=function(){f.get("/utils/time/datetime",function(k){j.datetime=k;j.newDatetime=k.str})};j.saveDatetime=function(){f.post("/backend/datetime",{datetime:j.newDatetime},function(k){f.setProcessing(true);var l=function(){f.get("backend/datetime",function(m){if(m.status!="finish"){f.setProcessing(true);d(l,500,e)}})};d(l,500,e)})};j.loadTimezone=function(){f.get("/utils/time/timezone",function(l){var k=l.timezone;j.timezone=k?k:"时区不可识别";if(k){var m=k.split("/");j.timezone_region=m[0];j.timezone_city=m[1]}else{j.timezone_region="Asia";j.timezone_city="Shanghai"}})};j.loadTimezones=function(l,k){if(l){f.get("/utils/time/timezone_list/"+l,function(m){j.cities=m.cities;if(k){k.call()}})}else{f.get("/utils/time/timezone_list",function(n){j.regions=n.regions;var m=function(){f.get("/utils/time/timezone_list/"+j.timezone_region,function(o){j.cities=o.cities})};if(j.timezone_region){m()}else{d(m,500,e)}})}};j.setTimezone=function(l,k){j.timezone_region=l;j.loadTimezones(l,function(){j.timezone_city=k})};j.saveTimezone=function(){var l=j.timezone_region;var k=j.timezone_city;f.post("/utils/time/timezone",{timezone:l+"/"+k},function(m){if(m.code==0){j.loadTimezone();j.loadDatetime()}})};j.synctime=function(){var k="pool.ntp.org";f.post("/backend/ntpdate",{server:k},function(l){f.setProcessing(true);var m=function(){f.get("backend/ntpdate_"+k,function(n){if(n.status!="finish"){f.setProcessing(true);d(m,500,e)}else{j.loadDatetime()}})};d(m,500,e)})};j.ntpdChecking=true;var a=function(){j.installMessage="时间同步需要使用 NTP 服务，您当前尚未安装该服务。<br>是否安装？";j.showInstallBtn=true};var h=function(){j.startMessage="NTP 服务已安装但还未启动，是否启动？";j.showStartBtn=true};var g=function(){j.stopMessage="NTP 服务正在运行，是否停止？";j.showStopBtn=true};a();h();g();j.loadSync=function(){f.get("/query/service.ntpd",function(k){j.ntpdStatus=null;if(k["service.ntpd"]){j.ntpdStatus=k["service.ntpd"]["status"]}j.ntpdChecking=false})};j.install=function(){j.installMessage="正在安装，请稍候...";j.showInstallBtn=false;c.call(j,e,"/backend/yum_install","/backend/yum_install_base_ntp",{repo:"base",pkg:"ntp"},{wait:function(k){j.installMessage=k.msg},success:function(k){j.installMessage=k.msg;d(j.loadSync,3000,e)},error:function(k){j.installMessage=k.msg;d(j.loadSync,3000,e)}},true)};j.start=function(){j.startMessage="正在启动，请稍候...";j.showStartBtn=false;c.call(j,e,"/backend/service_start","/backend/service_start_ntpd",{name:"NTP",service:"ntpd"},{wait:function(k){j.startMessage=k.msg},success:function(k){j.startMessage=k.msg;d(function(){h();j.loadSync()},3000,e)},error:function(k){j.startMessage=k.msg;d(function(){h();j.loadSync()},3000,e)}},true)};j.stop=function(){j.stopMessage="正在停止，请稍候...";j.showStopBtn=false;c.call(j,e,"/backend/service_stop","/backend/service_stop_ntpd",{name:"NTP",service:"ntpd"},{wait:function(k){j.stopMessage=k.msg},success:function(k){j.stopMessage=k.msg;d(function(){g();j.loadSync()},3000,e)},error:function(k){j.stopMessage=k.msg;d(function(){g();j.loadSync()},3000,e)}},true)}}];var UtilsPartitionCtrl=["$scope","Module","Timeout","Request","Message","Backend",function(b,f,g,e,d,a){var c="utils.partition";f.init(c,"磁盘分区");b.loaded=false;b.waiting=true;b.loadDiskinfo=function(){e.get("/query/server.diskinfo",function(h){if(!b.loaded){b.loaded=true}b.diskinfo=h["server.diskinfo"];b.waiting=false})};b.swaponconfirm=function(h){b.devname=h;$("#swaponconfirm").modal()};b.swapon=function(){a.call(b,c,"/backend/swapon","/backend/swapon_on_"+b.devname,{devname:b.devname},{success:b.loadDiskinfo})};b.swapoffconfirm=function(h){b.devname=h;$("#swapoffconfirm").modal()};b.swapoff=function(){a.call(b,c,"/backend/swapoff","/backend/swapon_off_"+b.devname,{devname:b.devname},{success:b.loadDiskinfo})};b.umountconfirm=function(h){b.devname=h;$("#umountconfirm").modal()};b.umount=function(){a.call(b,c,"/backend/umount","/backend/mount_umount_"+b.devname,{devname:b.devname},{success:b.loadDiskinfo})};b.mountconfirm=function(h,i){b.devname=h;b.mountpoint="";b.fstype=i;e.get("/query/config.fstab("+h+")",function(j){if(j["config.fstab"]&&typeof(j["config.fstab"]["mount"])!="undefined"){b.mountpoint=j["config.fstab"]["mount"]}});$("#mountconfirm").modal()};b.selectmountpoint=function(h){b.selector_title="请选择挂载点";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.mountpoint?b.mountpoint:"/");b.selector.selecthandler=function(i){$("#selector").modal("hide");b.mountpoint=i};$("#selector").modal()};b.mount=function(){a.call(b,c,"/backend/mount","/backend/mount_mount_"+b.devname,{devname:b.devname,mountpoint:b.mountpoint,fstype:b.fstype},{success:b.loadDiskinfo})};b.formatconfirm=function(h){b.devname=h;e.get("/query/tool.supportfs",function(i){b.supportfs=i["tool.supportfs"]});$("#formatconfirm").modal()};b.format=function(){a.call(b,c,"/backend/format","/backend/format_"+b.devname,{devname:b.devname,fstype:b.fstype},{success:b.loadDiskinfo})};b.addpartconfirm=function(h,i){b.devname=h;b.unpartition=i;$("#addpartconfirm").modal()};b.addpart=function(){b.waiting=true;d.setInfo("正在 "+b.devname+" 上创建分区，请稍候...",true);e.post("/operation/fdisk",{action:"add",devname:b.devname,size:b.size,unit:b.unit},function(h){if(h.code==0){b.loadDiskinfo()}else{b.waiting=false}})};b.delpartconfirm=function(h){b.devname=h;$("#delpartconfirm").modal()};b.delpart=function(){b.waiting=true;d.setInfo("正在删除分区 "+b.devname+"，请稍候...",true);e.post("/operation/fdisk",{action:"delete",devname:b.devname},function(h){if(h.code==0){b.loadDiskinfo()}else{b.waiting=false}})};b.scanpartconfirm=function(h){b.devname=h;$("#scanpartconfirm").modal()};b.scanpart=function(){b.waiting=true;d.setInfo("正在扫描 "+b.devname+" 的分区，请稍候...",true);e.post("/operation/fdisk",{action:"scan",devname:b.devname},function(h){if(h.code==0){g(b.loadDiskinfo,1000,c)}else{b.waiting=false}})}}];var UtilsAutoFMCtrl=["$scope","Module","Timeout","Request","Message","Backend",function(b,f,g,e,d,a){var c="utils.autofm";f.init(c,"自动格式化挂载");b.loaded=false;b.waiting=true;b.diskcount=0;b.loadDiskinfo=function(){e.get("/query/server.diskinfo",function(j){if(!b.loaded){b.loaded=true}b.diskinfo=j["server.diskinfo"];b.waiting=false;b.diskcount=0;for(var h in j["server.diskinfo"]["partitions"]){var k=j["server.diskinfo"]["partitions"][h];if(k.is_hw&&!k.is_pv&&k.partcount==0&&!k.mount){b.diskcount++}}})};b.confirm=function(h){b.devname=h;b.mountpoint="";b.fstype="";e.post("/operation/file",{action:"listdir",path:"/data",showhidden:true,remember:false},function(l){if(l.code==0){var j=l.data;if(j.length==0){b.mountpoint="/data/0"}else{var m={};for(var k=0;k<j.length;k++){m[j[k].name]=true}var n=0;while(1){if(!m[""+n]){break}n++}b.mountpoint="/data/"+n}}else{e.post("/operation/file",{action:"createfolder",path:"/",name:"data"});b.mountpoint="/data/0"}},false,true);e.get("/query/tool.supportfs",function(l){var j=l["tool.supportfs"];for(var k=0;k<j.length;k++){if(j[k]=="swap"){j.splice(k,1)}if(j[k]=="xfs"){b.fstype="xfs"}else{if(j[k]=="ext4"){b.fstype="ext4"}else{if(j[k]=="ext3"){b.fstype="ext3"}}}}b.supportfs=j});$("#confirm").modal()};b.selectmountpoint=function(h){b.selector_title="请选择挂载点";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.mountpoint);b.selector.selecthandler=function(i){$("#selector").modal("hide");b.mountpoint=i};$("#selector").modal()};b.autofm=function(){e.post("/operation/file",{action:"listdir",path:b.mountpoint,showhidden:true,remember:false},function(l){if(l.code==0){var h=l.data;if(h.length>0){var o=false;for(var k=0;k<h.length;k++){if(h[k].name=="lost+found"){o=true;break}}if(o){d.setError("已有其它设备挂载在 "+b.mountpoint+" 下，请重新选择挂载点。")}else{d.setError("挂载点 "+b.mountpoint+" 下存在文件或目录，无法挂载！请重新选择挂载点。")}}else{b.format()}}else{var n=b.mountpoint.split("/");var j=n.pop();var m=n.join("/");e.post("/operation/file",{action:"createfolder",path:m,name:j},b.format)}},false,true)};b.mount=function(){a.call(b,c,"/backend/mount","/backend/mount_mount_"+b.devname,{devname:b.devname,mountpoint:b.mountpoint,fstype:b.fstype},{success:b.loadDiskinfo})};b.format=function(){a.call(b,c,"/backend/format","/backend/format_"+b.devname,{devname:b.devname,fstype:b.fstype},{success:b.mount})}}];var UtilsMoveDataCtrl=["$scope","Module","Timeout","Request","Message","Backend",function(b,f,g,e,d,a){var c="utils.movedata";f.init(c,"数据移至数据盘");b.loaded=false;b.waiting=true;b.srcpath="/var";b.despath="/";b.mountpoint="/";b.loadMounts=function(){e.get("/query/server.mounts",function(h){if(!b.loaded){b.loaded=true}b.mounts=h["server.mounts"];b.waiting=false})};b.setdespath=function(h){b.despath=h};b.selectsrcpath=function(h){b.selector_title="请选择要迁移的目录（原始目录）";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.srcpath);b.selector.selecthandler=function(i){$("#selector").modal("hide");b.srcpath=i};$("#selector").modal()};b.selectdespath=function(h){b.selector_title="请选择要迁移到的目录（目标目录）";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.despath);b.selector.selecthandler=function(i){$("#selector").modal("hide");b.despath=i};$("#selector").modal()};b.movedata=function(){b.waiting=true;var i=b.srcpath.replace(/\/$/,"");var j=i.split("/").pop();var h=b.despath.replace(/\/$/,"")+"/"+j;if(h==i){d.setError("路径没有改变，无须迁移！");b.waiting=false;return}d.setInfo("正在检测，请稍候...",true);e.post("/operation/file",{action:"getitem",path:i},function(k){if(k.code==0){if(!k.data.isdir){d.setError(b.srcpath+" 不是有效的目录！（可能是文件或链接）");b.waiting=false;return}e.post("/operation/file",{action:"getitem",path:h},function(l){if(l.code==0){d.setError("目标目录下已有同名文件或目录 "+h+"，迁移失败！");b.waiting=false}else{a.call(b,c,"/backend/move","/backend/move_"+i+"_"+h,{srcpath:i,despath:h},{success:function(m){d.setInfo("正在原始目录创建链接...");e.post("/operation/file",{action:"link",srcpath:h,despath:i},function(n){if(n.code==0){d.setSuccess("迁移完成！")}else{d.setError("迁移失败！"+n.msg)}b.waiting=false},false,true)},error:function(m){d.setError("迁移过程中发生错误，迁移失败！");b.waiting=false}})}},false,true)}})}}];var FileCtrl=["$scope","$routeParams","Module","Message","Request","Backend",function(o,e,m,l,p,d){var i="file";m.init(i,"文件管理");var a=e.path;var f=e.file;var c=true;var r=true;o.path=o.lastpath="/root";o.curpath="";o.showhidden=false;o.clipboard={srcpath:"",count:0,items:{}};o.confirm=o.cancel=function(){};var k=function(){var v=o.curpath.split("/");var u=[];for(var s=1;s<v.length;s++){if(!v[s]){continue}var t=v[s-1]+"/"+v[s];u.push({name:v[s],path:t});v[s]=t}o.pathinfos=u};o.loaded=false;o.load=function(){if(a||f){o.loaded=true;c=false;r=false;if(f){a=f.split("/");f=a.pop();a=a.join("/");if(!a){a="/"}}o.listdir(a,true,function(){if(f){o.editfile(f)}})}else{p.post("/operation/file",{action:"last"},function(u){if(u.code==0){o.loaded=true;var s=u.data.lastfile;var t=u.data.lastdir;o.listdir(t,true,function(){if(s&&s.indexOf(t)===0){s=s.replace(t+"/","");if(s.indexOf("/")==-1){o.editfile(s)}}})}},false,true)}};o.listdir=function(u,s,t){if(u){o.path=u}if(o.path==""){o.path="/root"}else{if(o.path!="/"&&o.path.substr(-1)=="/"){o.path=o.path.substr(0,o.path.length-1)}}o.path=o.path.replace("//","/");var v=o.path;p.post("/operation/file",{action:"listdir",path:v,showhidden:o.showhidden,remember:c},function(w){if(w.code==0){o.items=w.data;o.curpath=v;o.lastpath=v;if(s){o.selects={};o.selectall=false}}else{o.path=o.lastpath}k();if(t){t.call()}},false,true)};o.getitem=function(s,t){if(!t){t=s}else{delete o.selects[t]}p.post("/operation/file",{action:"getitem",path:o.curpath+"/"+s},function(z){if(z.code==0){var v=z.data;var y=false;for(var u=0;u<o.items.length;u++){if(o.items[u].name==t){o.items[u]=v;y=true;break}}if(!y){var w=false;var u=0;if(v.isdir||v.islnk&&v.link_isdir){for(;u<o.items.length;u++){var x=o.items[u];if(x.isdir||x.islnk&&x.link_isdir){if(o.items[u].name.localeCompare(v.name)>1){o.items.splice(u,0,v);w=true;break}}else{break}}}else{for(;u<o.items.length;u++){var x=o.items[u];if(x.isdir||x.islnk&&x.link_isdir){continue}if(o.items[u].name.localeCompare(v.name)>1){o.items.splice(u,0,v);w=true;break}}}if(!w){o.items.splice(u,0,v)}}}else{for(var u=0;u<o.items.length;u++){if(o.items[u].name==s){o.items.splice(u,1);break}}}},false,true)};o.upandlist=function(){var s=o.curpath.split("/");s.pop();o.listdir(s.join("/")+"/",true)};o.editfile=function(s){p.post("/operation/file",{action:"fread",path:o.curpath+"/"+s,remember:r},function(u){if(u.code==0){l.setSuccess("");var t=u.data;o.filename=t.filename;o.filepath=t.filepath;o.filecharset=t.charset;o.filecharset_org=t.charset;g.setValue("");$("#list").hide();$("#edit").show();g.setOption("mode",t.mimetype);g.setValue(t.content);n=false}})};o.return2list=o.canceledit=function(){if(n){o.confirm_title="是否放弃修改？";o.confirm_body=o.filepath+" 已被修改，是否放弃修改？";$("#confirm").modal();o.cancel=function(){};o.confirm=function(){$("#edit").hide();$("#list").show();p.post("/operation/file",{action:"fclose"},false,false,true)}}else{$("#edit").hide();$("#list").show();p.post("/operation/file",{action:"fclose"},false,false,true)}};o.savefile=function(){if(!n&&o.filecharset==o.filecharset_org){l.setInfo("文件未修改，无须保存！");return}p.post("/operation/file",{action:"fwrite",path:o.filepath,charset:o.filecharset,content:g.getValue()},function(s){if(s.code==0){n=false;o.getitem(o.filename)}})};o.newfolder=function(){o.newname_title="新建文件夹";o.newname_label="文件夹名称";o.newname_name="";$("#newname").modal();o.newname=function(){p.post("/operation/file",{action:"createfolder",path:o.curpath,name:o.newname_name},function(s){if(s.code==0){o.getitem(o.newname_name)}})}};o.newfile=function(){o.newname_title="新建文件";o.newname_label="文件名称";o.newname_name="";$("#newname").modal();o.newname=function(){p.post("/operation/file",{action:"createfile",path:o.curpath,name:o.newname_name},function(s){if(s.code==0){o.getitem(o.newname_name)}})}};o.upload=function(){$("#upload").modal()};o.doupload=function(){var s=$("#uploadform").find("input[name=ufile]").val().split(/[\\\/]/);var t=s[s.length-1];p.post("/operation/file",{action:"getitem",path:o.curpath+"/"+t},function(u){if(u.code==0){o.confirm_title="上传文件覆盖确认";o.confirm_body="<p>系统检测到当前目录下已存在同名文件 "+t+"。</p><p>确认要覆盖这个文件吗？</p>";$("#confirm").modal();o.confirm=function(){$("#uploadform").submit()}}else{$("#uploadform").submit()}},false,true)};o.download=function(){$("#download").modal();o.dodownload=function(){d.call(o,i,"/backend/wget","/backend/wget_"+encodeURIComponent(encodeURIComponent(o.downloadurl)),{url:o.downloadurl,path:o.curpath},{success:function(s){o.listdir()}})}};o.togglehidden=function(){o.showhidden=!o.showhidden;o.listdir()};o.rename=function(s){o.newname_title="重命名";o.newname_label="新名称";o.newname_name=s;$("#newname").modal();o.newname=function(){p.post("/operation/file",{action:"rename",path:o.curpath+"/"+s,name:o.newname_name},function(t){if(t.code==0){o.getitem(o.newname_name,s)}})}};var q=function(s){return function(u,v){var t=o.clipboard;if(t.srcpath!=o.curpath){t.items={};t.count=0}if(typeof v=="undefined"){if(typeof t.items[u]=="undefined"){t.srcpath=o.curpath;t.items[u]=s;t.count++}else{if(t.items[u]==s){delete t.items[u];t.count--}else{if(typeof v=="undefined"){t.items[u]=s}}}}else{if(v){if(typeof t.items[u]=="undefined"){t.srcpath=o.curpath;t.count++}t.items[u]=s}else{if(typeof t.items[u]!="undefined"){delete t.items[u];t.count--}}}}};o.togglecopy=q("copy");o.togglecut=q("cut");o.togglelink=q("link");o.paste=function(){h()};var b=function(v,u,s,t){if(v=="copy"){d.call(o,i,"/backend/copy","/backend/copy_"+u+"_"+s,{srcpath:u,despath:s},{success:function(w){delete o.clipboard.items[t];o.listdir();h()},error:function(w){o.listdir()}})}else{if(v=="cut"){d.call(o,i,"/backend/move","/backend/move_"+u+"_"+s,{srcpath:u,despath:s},{success:function(w){delete o.clipboard.items[t];o.listdir();h()},error:function(w){o.listdir()}})}else{if(v=="link"){p.post("/operation/file",{action:"link",srcpath:u,despath:s},function(w){if(w.code==0){o.listdir();delete o.clipboard.items[t];h()}})}}}};var h=function(t){var s="";for(s in o.clipboard.items){break}if(!s){return}var u=o.clipboard.items[s];p.post("/operation/file",{action:"exist",name:t?t:s,path:o.curpath},function(x){if(x.code==0){var w=o.clipboard.srcpath+"/"+s;var v=o.curpath+"/"+(t?t:s);if(x.data){o.overwrite_filename=(t?t:s);o.overwrite_option="rename";o.overwrite_newname=(t?t:s)+".new";$("#overwriteconfirm").modal();o.overwrite=function(){if(o.overwrite_option=="rename"){h(o.overwrite_newname)}else{b(u,w,v,s)}}}else{b(u,w,v,s)}}})};o.move2trash=function(s){p.post("/operation/file",{action:"delete",paths:o.curpath+"/"+s},function(v){if(v.code==0){o.getitem(s);var u="."+s+".bak";for(var t=0;t<o.items.length;t++){if(o.items[t].name==u){o.getitem(u);break}}}})};o.compressconfirm=function(s,t){o.compress_isreg=t;o.compress_type=t?".gz":".tar.gz";o.compress_zipname=s;o.compress_name=s;o.compress_names=[];$("#compressconfirm").modal()};o.compress=function(){var t=o.curpath+"/"+o.compress_zipname+o.compress_type;var s=o.curpath+"/"+o.compress_name;d.call(o,i,"/backend/compress","/backend/compress_"+t+"_"+s,{zippath:t,paths:s},{success:function(v){var u=o.compress_zipname+o.compress_type;if(o.compress_type==".gz"){o.getitem(u,o.compress_name)}else{o.getitem(u)}}})};o.decompress=function(t){var u=t.split(".");var s=u.pop();var w=u.pop();if(s=="gz"&&w!="tar"){var v=o.curpath+"/"+t;d.call(o,i,"/backend/decompress","/backend/decompress_"+v+"_",{zippath:v},{success:function(x){o.getitem(t.substr(0,t.length-3),t)}});return}o.selector_title="请选择要解压到的目录";o.selector.onlydir=true;o.selector.onlyfile=false;o.selector.load(o.curpath);o.selector.selecthandler=function(x){$("#selector").modal("hide");l.setInfo("正在检测目录...",true);p.post("/operation/file",{action:"listdir",path:x,showhidden:true,remember:false},function(z){if(z.code==0){l.setInfo("");var y=function(){var A=o.curpath+"/"+t;d.call(o,i,"/backend/decompress","/backend/decompress_"+A+"_"+x,{zippath:A,despath:x},{success:function(B){if(o.curpath==x){o.listdir()}}})};if(z.data.length>0){o.confirm_title="解压确认";o.confirm_body="<p>系统检测到目录 "+x+" 下存在文件，继续解压将可能覆盖这些文件。</p><p>确认要继续解压吗？</p>";$("#confirm").modal();o.confirm=y}else{y()}}else{l.setError("检测目录失败！")}},false,true)};$("#selector").modal()};o.$watch("selectall",function(s){angular.forEach(o.items,function(t){o.selects[t.name]=s})});o.multicopy=function(){angular.forEach(o.selects,function(s,t){o.togglecopy(t,s)})};o.multicut=function(){angular.forEach(o.selects,function(s,t){o.togglecut(t,s)})};o.multidel=function(){var s=[];angular.forEach(o.selects,function(t,u){if(t){s.push(o.curpath+"/"+u)}});if(s.length==0){return}p.post("/operation/file",{action:"delete",paths:s.join(",")},function(t){if(t.code==0){o.listdir()}})};o.tarconfirm=function(){var s=[];angular.forEach(o.selects,function(t,u){if(t){s.push(u)}});if(s.length==0){return}if(s.length==1){o.compressconfirm(s[0],false);return}o.compress_isreg=false;o.compress_type=".tar.gz";o.compress_zipname=o.curpath.split("/").pop();o.compress_name="多个项目";o.compress_names=s;$("#compressconfirm").modal()};o.tar=function(){var u=o.curpath+"/"+o.compress_zipname+o.compress_type;var t=[];for(var s=0;s<o.compress_names.length;s++){t.push(o.curpath+"/"+o.compress_names[s])}d.call(o,i,"/backend/compress","/backend/compress_"+u+"_"+t.join(","),{zippath:u,paths:t.join(",")},{success:function(v){o.listdir()}})};o.chownconfirm=function(u,t,w,s){if(!u){var v=[];angular.forEach(o.selects,function(x,y){if(x){v.push(y)}});if(v.length==0){return}}if(!o.users){p.post("/operation/user",{action:"listuser",fullinfo:false},function(x){if(x.code==0){o.users=x.data}},false,true)}if(!o.groups){p.post("/operation/user",{action:"listgroup",fullinfo:false},function(x){if(x.code==0){o.groups=x.data}},false,true)}if(u){o.chown_user=t;o.chown_group=w;o.chown_names=[u];o.chown_recursively=true;o.chown_hasdir=s}else{o.chown_names=v;o.chown_recursively=true;o.chown_hasdir=true}$("#chownconfirm").modal()};o.chown=function(){var t=[];for(var s=0;s<o.chown_names.length;s++){t.push(o.curpath+"/"+o.chown_names[s])}t=t.join(",");d.call(o,i,"/backend/chown","/backend/chown_"+t,{paths:t,user:o.chown_user,group:o.chown_group,recursively:o.chown_recursively},{success:function(u){if(o.chown_names.length==1){o.getitem(o.chown_names[0])}else{o.listdir()}}})};o.chmodconfirm=function(t,u,s){if(!t){var v=[];angular.forEach(o.selects,function(w,x){if(w){v.push(x)}});if(v.length==0){return}u="0744"}u=parseInt(u,8);o.chmod_permbits=[[(u&256)!=0,(u&128)!=0,(u&64)!=0],[(u&32)!=0,(u&16)!=0,(u&8)!=0],[(u&4)!=0,(u&2)!=0,(u&1)!=0],];o.chmod_recursively=true;if(t){o.chmod_names=[t];o.chmod_hasdir=s}else{o.chmod_names=v;o.chmod_hasdir=true}$("#chmodconfirm").modal()};o.chmod=function(){var u=0;for(var t=0;t<3;t++){for(var s=0;s<3;s++){u|=(o.chmod_permbits[t][s]<<(8-t*3-s))}}u=u.toString(8);var v=[];for(var t=0;t<o.chmod_names.length;t++){v.push(o.curpath+"/"+o.chmod_names[t])}v=v.join(",");d.call(o,i,"/backend/chmod","/backend/chmod_"+v,{paths:v,perms:u,recursively:o.chmod_recursively},{success:function(w){if(o.chmod_names.length==1){o.getitem(o.chmod_names[0])}else{o.listdir()}}})};var n=false;var g=CodeMirror(document.getElementById("editor"),{value:"",lineNumbers:true,lineWrapping:true,matchBrackets:true,onCursorActivity:function(){g.setLineClass(j,null,null);j=g.setLineClass(g.getCursor().line,null,"activeline");if(!$.browser.msie){g.matchHighlight("CodeMirror-matchhighlight")}},onChange:function(){n=true}});var j=g.setLineClass(0,"activeline")}];var FileTrashCtrl=["$scope","$routeParams","Module","Message","Request","Backend",function(c,a,g,f,e,b){var d="file.trash";g.init(d,"回收站管理");c.loaded=true;c.confirm=function(){};c.tlist=function(){e.post("/operation/file",{action:"tlist"},function(h){if(h.code==0){c.items=h.data}})};c.restore=function(h,i){e.post("/operation/file",{action:"trestore",mount:h,uuid:i},function(j){if(j.code==0){c.tlist()}})};c.tdeleteconfirm=function(i,h,j){c.confirm_title="删除确认";c.confirm_body="<p>删除后文件将不可恢复！</p><p>确认要删除 "+i+" 吗？</p>";$("#confirm").modal();c.confirm=function(){c.tdelete(h,j)}};c.tdelete=function(h,i){e.post("/operation/file",{action:"titem",mount:h,uuid:i},function(j){if(j.code==0){var k=j.data.realpath;b.call(c,d,"/backend/remove","/backend/remove_"+k,{paths:k},function(){e.post("/operation/file",{action:"tdelete",mount:h,uuid:i},function(l){if(l.code==0){c.tlist()}})})}})};c.tcleanconfirm=function(){c.confirm_title="清空确认";c.confirm_body="<p>清空回收站后，回收站中的所有文件都将被删除且不可恢复！<p>								<p>确认要清空回收站吗？</p>";$("#confirm").modal();c.confirm=function(){c.tclean()}};c.tclean=function(){e.post("/operation/file",{action:"trashs"},function(h){if(h.code==0){var i=h.data.join(",");b.call(c,d,"/backend/remove","/backend/remove_"+i,{paths:i},function(){f.setSuccess("清空回收站完成！");c.tlist()})}})}}];var SiteCtrl=["$scope","Module","$routeParams","Request","Message","Backend",function(i,b,h,f,a,c){var e="site";b.init(e,"网站管理");i.loaded=false;var g=b.getSection();i.has_httpserver=false;i.nginx_supported=false;i.apache_supported=false;i.site_packages=[];i.load=function(){f.get("/query/service.nginx,service.httpd",function(j){if(j["service.nginx"]&&j["service.nginx"].status){i.nginx_supported=true}if(j["service.httpd"]&&j["service.httpd"].status){i.apache_supported=true}i.has_httpserver=i.nginx_supported||i.apache_supported;if(i.has_httpserver){if(g){if(g=="nginx"&&i.nginx_supported){b.setSection("nginx")}else{if(g=="apache"&&i.apache_supported){b.setSection("apache")}else{if(g=="package"){b.setSection("package")}else{b.setSection(i.nginx_supported?"nginx":"apache")}}}}else{b.setSection(i.nginx_supported?"nginx":"apache")}}i.loaded=true;i.loadsites()});f.get("/sitepackage/getlist",function(j){if(j.code==0){i.site_packages=j.data}})};i.package_install_setting=function(j){i.curpkg=j;i.curver=j.versions[0];i.pkgver=i.curver.code;i.installpath="/var/www";$("#pkg_install_setting").modal()};i.package_version_select=function(j){i.pkgver=j.code;i.curver=j};i.selectinstallpath=function(j){i.selector_title="请选择安装目录";i.selector.onlydir=true;i.selector.onlyfile=false;i.selector.load(i.installpath);i.selector.selecthandler=function(k){$("#selector").modal("hide");i.installpath=k};$("#selector").modal()};i.package_install=function(){a.setInfo("正在检测安装目录...",true);f.post("/operation/file",{action:"listdir",path:i.installpath,showhidden:true,remember:false},function(j){if(j.code==0){a.setInfo("");if(j.data.length>0){i.confirm_title="安装确认";i.confirm_body="<p>系统检测到目录 "+i.installpath+" 下存在文件，继续安装将可能会覆盖原文件。</p><p>确认要继续安装吗？</p>";$("#confirm").modal();i.confirm=d}else{d()}}else{a.setError("安装失败！"+j.msg)}},false,true)};function d(){a.setInfo("正在请求安装文件...");f.get("/sitepackage/getdownloadtask?name="+i.curpkg.code+"&version="+i.pkgver,function(j){if(j.code==0){i.downloadurl=j.data.url;i.downloadpath=j.data.path;i.extractpath=j.data.temp;c.call(i,e,"/backend/wget","/backend/wget_"+encodeURIComponent(encodeURIComponent(i.downloadurl)),{url:i.downloadurl,path:i.downloadpath},{success:function(l){var m=i.downloadpath;var k=i.extractpath;c.call(i,e,"/backend/decompress","/backend/decompress_"+m+"_"+k,{zippath:m,despath:k},{success:function(p){var q=i.curver.core_path;var o=i.extractpath+"/"+q+"/*";var n=i.installpath;c.call(i,e,"/backend/copy","/backend/copy_"+o+"_"+n,{srcpath:o,despath:n},{success:function(r){a.setInfo("正在清理安装临时文件...");c.call(i,e,"/backend/remove","/backend/remove_"+i.extractpath,{paths:i.extractpath},function(){a.setInfo("正在设置目录权限...");c.call(i,e,"/backend/chown","/backend/chown_"+i.installpath,{paths:i.installpath,user:"apache",group:"apache",recursively:true},{success:function(s){a.setSuccess(i.curpkg.name+" v"+i.pkgver+" 安装完成！")}})},true)},error:function(r){a.setError("复制安装文件过程中出现错误，安装取消！")}})}})},error:function(k){a.setError("下载安装包过程中出现错误，安装取消！")}},false)}})}i.loadsites=function(){if(i.nginx_supported){i.loadnginx()}if(i.apache_supported){i.loadapache()}};i.loadnginx=function(){f.post("/operation/nginx",{action:"getservers"},function(j){if(j.code==0){i.servers=j.data}})};i.loadapache=function(){};i.nginx_enableserver=function(l,j,k){f.post("/operation/nginx",{action:"enableserver",ip:l,port:j,server_name:k},function(m){if(m.code==0){i.loadnginx()}})};i.nginx_disableserver=function(l,j,k){f.post("/operation/nginx",{action:"disableserver",ip:l,port:j,server_name:k},function(m){if(m.code==0){i.loadnginx()}})};i.nginx_deleteserverconfirm=function(l,j,k){i.nginx_ip=l;i.nginx_port=j;i.nginx_server_name=k;$("#nginx_deleteserverconfirm").modal()};i.nginx_deleteserver=function(){f.post("/operation/nginx",{action:"deleteserver",ip:i.nginx_ip,port:i.nginx_port,server_name:i.nginx_server_name},function(j){if(j.code==0){i.loadnginx()}})}}];var SiteNginxCtrl=["$scope","Module","$routeParams","$location","Request","Backend","Timeout",function(p,m,c,d,q,b,u){var e=c.section;var r=e=="new"?"new":"edit";var l=r=="edit"?e.substr(5):"";var f,g,s;if(r=="edit"){l=l.split("_");if(l.length==3){f=l[0];g=l[1];s=l[2]}else{if(l.length==4&&l[3]==""){f=l[0];g=l[1];s="_"}else{d.path("/site");return}}}var j="site.nginx";m.init(j,r=="new"?"新建站点（Nginx）":"编辑站点（Nginx）");p.loaded=false;p.showglobaladv=false;p.curloc=-1;p.setloc=function(v){p.curloc=v};p.action=r;var i={server_names:[],listens:[],charset:"",index:"index.html index.htm index.php",locations:[],limit_rate:"",limit_conn:"",ssl_crt:"",ssl_key:"",rewrite_enable:false,rewrite_rules:""};var n={name:"",default_name:false};var t={ip:"",port:"80",ssl:false,default_server:false};var k={urlpath:"/",engine:"static","static":{root:"/var/www/",autocreate:true,autoindex:false,rewrite_enable:false,rewrite_detect_file:true,rewrite_rules:""},fastcgi:{root:"/var/www/",autocreate:true,fastcgi_pass:"127.0.0.1:9000",rewrite_enable:false,rewrite_detect_file:true,rewrite_rules:""},proxy:{protocol:"http",host:"",realip:true,charset:"",backends:[],balance:"ip_hash",keepalive:"10",proxy_cache_enable:false,proxy_cache:"",proxy_cache_min_uses:"",proxy_cache_methods_post:false,proxy_cache_key:{schema:true,host:false,proxy_host:true,uri:true,},proxy_cache_valid:[],proxy_cache_use_stale:{error:false,timeout:false,invalid_header:false,updating:false,http_500:false,http_502:false,http_503:false,http_504:false,http_404:false},proxy_cache_lock:false,proxy_cache_lock_timeout:"5"},redirect:{url:"",type:"301",option:"keep"},error:{code:"404"}};var o={server:"",weight:"",fail_timeout:"10",max_fails:"3"};var a={code:"any",time:"1",time_unit:"h"};p.setting=angular.copy(i);p.gen_by_vpsmate=r=="new"?true:false;var h={"301_1":"rewrite ^ http://example.com$request_uri? permanent","301_2":"rewrite ^ http://example.com/ permanent","302_1":"rewrite ^ http://example.com$request_uri? redirect","302_2":"rewrite ^ http://example.com/ redirect"};p.$watch("rewrite_template",function(v){p.setting.rewrite_rules=v?h[v]:""});p.load=function(){if(r=="new"){p.loaded=true}else{p.getserver()}b.call(p,j,"/backend/yum_info","/backend/yum_info_nginx",{pkg:"nginx",repo:"installed"},{success:function(v){p.nginx_version=v.data[0].version},error:function(v){p.nginx_version=""}},true);p.loadproxycaches()};p.proxy_caches=[];p.loadproxycaches=function(){q.post("/operation/nginx",{action:"gethttpsettings",items:"proxy_cache_path[]"},function(x){if(x.code==0){var v=$.browser.msie?[""]:[];var y=x.data.proxy_cache_path;if(y){for(var w=0;w<y.length;w++){v.push(y[w].name)}}p.proxy_caches=v}},false,true)};p.getserver=function(v){q.post("/operation/nginx",{action:"getserver",ip:f,port:g,server_name:s},function(D){if(D.code==0){var F=D.data;var K=p.setting;p.gen_by_vpsmate=F._vpsmate;for(B in F.server_names){var x=F.server_names[B];K.server_names.push({name:x,default_name:x=="_"})}for(B in F.listens){var C=F.listens[B];var I=angular.copy(t);if(typeof C.ip!="undefined"){I.ip=C.ip}if(typeof C.port!="undefined"){I.port=C.port}if(typeof C.ssl!="undefined"){I.ssl=C.ssl}if(typeof C.default_server!="undefined"){I.default_server=C.default_server}K.listens.push(I)}if(F.index){K.index=F.index}if(F.charset){K.charset=F.charset}if(F.limit_rate){K.limit_rate=F.limit_rate}if(F.limit_conn){K.limit_conn=F.limit_conn}if(F.ssl_crt){K.ssl_crt=F.ssl_crt}if(F.ssl_key){K.ssl_key=F.ssl_key}if(F.rewrite_rules){K.rewrite_rules=F.rewrite_rules.join("\n");if(K.rewrite_rules){K.rewrite_enable=true}}if(F.locations){for(B in F.locations){var E=F.locations[B];var I=angular.copy(k);if(typeof E.urlpath!="undefined"){I.urlpath=E.urlpath;I.oldurlpath=I.urlpath}if(typeof E.error_code!="undefined"){I.engine="error";I.error.code=E.error_code}else{if(typeof E.fastcgi_pass!="undefined"){I.engine="fastcgi";I.fastcgi.fastcgi_pass=E.fastcgi_pass;if(E.root){I.fastcgi.root=E.root}I.fastcgi.rewrite_detect_file=E.rewrite_detect_file?true:false;if(E.rewrite_rules){I.fastcgi.rewrite_rules=E.rewrite_rules.join(";\n");if(I.fastcgi.rewrite_rules){I.fastcgi.rewrite_rules+=";";I.fastcgi.rewrite_enable=true}}}else{if(typeof E.proxy_protocol!="undefined"){I.engine="proxy";I.proxy.protocol=E.proxy_protocol;if(typeof E.proxy_host!="undefined"){I.proxy.host=E.proxy_host}if(typeof E.proxy_realip!="undefined"){I.proxy.realip=E.proxy_realip}if(typeof E.proxy_balance!="undefined"){I.proxy.balance=E.proxy_balance}if(typeof E.proxy_keepalive!="undefined"){I.proxy.keepalive=E.proxy_keepalive}for(B in E.proxy_backends){var w=E.proxy_backends[B];var G=angular.copy(o);if(typeof w.server!="undefined"){G.server=w.server}if(typeof w.weight!="undefined"){G.weight=w.weight}if(typeof w.fail_timeout!="undefined"){G.fail_timeout=w.fail_timeout}if(typeof w.max_fails!="undefined"){G.max_fails=w.max_fails}I.proxy.backends.push(G)}if(typeof E.proxy_cache!="undefined"){I.proxy.proxy_cache_enable=true;I.proxy.proxy_cache=E.proxy_cache;if(typeof E.proxy_cache_min_uses!="undefined"){I.proxy.proxy_cache_min_uses=E.proxy_cache_min_uses}if(typeof E.proxy_cache_methods!="undefined"){I.proxy.proxy_cache_methods_post=E.proxy_cache_methods=="POST"}if(typeof E.proxy_cache_key!="undefined"){var A=E.proxy_cache_key.split("$");var J=I.proxy.proxy_cache_key;for(var B=0;B<A.length;B++){if(A[B]=="schema"){J.schema=true}else{if(A[B]=="host"){J.host=true}else{if(A[B]=="proxy_host"){J.proxy_host=true}else{if(A[B]=="request_uri"){J.uri=true}}}}}}if(typeof E.proxy_cache_valid!="undefined"){var z=E.proxy_cache_valid;for(var B=0;B<z.length;B++){I.proxy.proxy_cache_valid.push({code:z[B].code,time:parseInt(z[B].time)+"",time_unit:z[B].time.substr(z[B].time.length-1),})}}if(typeof E.proxy_cache_use_stale!="undefined"){var y=E.proxy_cache_use_stale;var H=I.proxy.proxy_cache_use_stale;for(var B=0;B<y.length;B++){if(y[B]=="error"){H.error=true}else{if(y[B]=="timeout"){H.timeout=true}else{if(y[B]=="invalid_header"){H.invalid_header=true}else{if(y[B]=="updating"){H.updating=true}else{if(y[B]=="http_500"){H.http_500=true}else{if(y[B]=="http_502"){H.http_502=true}else{if(y[B]=="http_503"){H.http_503=true}else{if(y[B]=="http_504"){H.http_504=true}else{if(y[B]=="http_404"){H.http_404=true}}}}}}}}}}}if(typeof E.proxy_cache_lock!="undefined"){I.proxy.proxy_cache_lock=E.proxy_cache_lock;if(typeof E.proxy_cache_lock_timeout!="undefined"){I.proxy.proxy_cache_lock_timeout=E.proxy_cache_lock_timeout}}}}else{if(typeof E.redirect_url!="undefined"){I.engine="redirect";I.redirect.url=E.redirect_url;if(typeof E.redirect_type!="undefined"){I.redirect.type=E.redirect_type}if(typeof E.redirect_option!="undefined"){I.redirect.option=E.redirect_option}}else{if(typeof E.root!="undefined"){I.engine="static";I["static"].root=E.root;I["static"].rewrite_detect_file=E.rewrite_detect_file?true:false;if(typeof E.autoindex!="undefined"){I["static"].autoindex=E.autoindex}if(E.rewrite_rules){I["static"].rewrite_rules=E.rewrite_rules.join(";\n");if(I["static"].rewrite_rules){I["static"].rewrite_rules+=";";I["static"].rewrite_enable=true}}}}}}}if(I.proxy.backends.length==0){I.proxy.backends.push(angular.copy(o))}K.locations.push(I)}}p.curloc=0;p.loaded=true}else{u(function(){d.path("/site")},1000,j)}},false,v)};p.deleteservername=function(v){p.setting.server_names.splice(v,1)};p.addservername=function(){p.setting.server_names.push(angular.copy(n))};p.deletelisten=function(v){p.setting.listens.splice(v,1)};p.addlisten=function(){p.setting.listens.push(angular.copy(t))};p.deletelocation=function(v){p.setting.locations.splice(v,1);p.curloc--;if(p.curloc<0&&p.setting.locations.length>0){p.curloc=0}};p.addlocation=function(){var v=p.setting.locations;v.splice(p.curloc+1,0,angular.copy(k));p.proxy_addbackend(p.curloc+1);p.curloc++};p.proxy_deletebackend=function(v,w){p.setting.locations[v].proxy.backends.splice(w,1)};p.proxy_addbackend=function(v){p.setting.locations[v].proxy.backends.push(angular.copy(o));p.proxy_addvalid(v)};p.proxy_deletevalid=function(v,w){p.setting.locations[v].proxy.proxy_cache_valid.splice(w,1)};p.proxy_addvalid=function(v){p.setting.locations[v].proxy.proxy_cache_valid.push(angular.copy(a))};p.$watch("setting.server_names[0].name",function(D,x){var B=D;var v=x;var A=p.setting.locations;for(var z=0;z<A.length;z++){if(A[z].urlpath=="/"){var w=k["static"].root;var y=w+"/"+v;y=y.replace("//","/");if(A[z]["static"].root==y){var C=w+"/"+B;A[z]["static"].root=C.replace("//","/")}var w=k.fastcgi.root;var y=w+"/"+v;y=y.replace("//","/");if(A[z].fastcgi.root==y){var C=w+"/"+B;A[z].fastcgi.root=C.replace("//","/")}}}});p.urlpathchange=function(w){if(w.urlpath.length==0){w.urlpath="/"}if(w.engine=="fastcgi"&&w.fastcgi.rewrite_enable){var v=new RegExp("([\\^\\s])("+(w.oldurlpath+"/").replace("//","/").replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")","gm");w.fastcgi.rewrite_rules=w.fastcgi.rewrite_rules.replace(v,"$1"+(w.urlpath+"/").replace("//","/"));w.oldurlpath=w.urlpath}};p.selectstaticfolder=function(v){p.selector_title="请选择站点目录";p.selector.onlydir=true;p.selector.onlyfile=false;p.selector.load(p.setting.locations[v]["static"].root);p.selector.selecthandler=function(w){$("#selector").modal("hide");p.setting.locations[v]["static"].root=w};$("#selector").modal()};p.selectfastcgifolder=function(v){p.selector_title="请选择站点目录";p.selector.onlydir=true;p.selector.onlyfile=false;p.selector.load(p.setting.locations[v].fastcgi.root);p.selector.selecthandler=function(w){$("#selector").modal("hide");p.setting.locations[v].fastcgi.root=w};$("#selector").modal()};p.selectsslcrt=function(v){p.selector_title="请选择CRT文件（*.crt）";p.selector.onlydir=false;p.selector.onlyfile=true;p.selector.load("/root");p.selector.selecthandler=function(w){$("#selector").modal("hide");p.setting.ssl_crt=w};$("#selector").modal()};p.selectsslkey=function(v){p.selector_title="请选择密钥文件（*.key）";p.selector.onlydir=false;p.selector.onlyfile=true;p.selector.load("/root");p.selector.selecthandler=function(w){$("#selector").modal("hide");p.setting.ssl_key=w};$("#selector").modal()};p.addserver=function(){q.post("/operation/nginx",{action:"addserver",version:p.nginx_version,setting:angular.toJson(p.setting)},function(x){if(x.code==0){var w=p.setting;p.loaded=false;var v=(w.listens[0].ip?w.listens[0].ip:"*")+"_"+w.listens[0].port+"_"+w.server_names[0].name;u(function(){d.path("/site/nginx/edit_"+encodeURIComponent(v))},1000,j)}})};p.updateserver=function(){q.post("/operation/nginx",{action:"updateserver",ip:f,port:g,server_name:s,version:p.nginx_version,setting:angular.toJson(p.setting)},function(x){if(x.code==0){var w=p.setting;p.loaded=false;var v=(w.listens[0].ip?w.listens[0].ip:"*")+"_"+w.listens[0].port+"_"+w.server_names[0].name;u(function(){var y="/site/nginx/edit_"+encodeURIComponent(v);if(y!=d.path()){d.path(y)}else{p.restore()}},1000,j)}})};p.restore=function(){p.setting=angular.copy(i);p.getserver()};if(e=="new"){p.addservername();p.addlisten();p.addlocation()}}];var ServiceCtrl=["$scope","$routeParams","Module","Timeout","Request","Backend",function(d,a,g,h,f,c){var e="service";g.init(e,"服务管理");g.initSection("http");d.scope=d;d.info=null;d.loaded=false;d.waiting=true;d.loadInfo=function(){f.get("/query/server.virt,service.**",function(i){if(!d.loaded){d.loaded=true}if(d.info==null){d.info=i}else{deepUpdate(d.info,i)}d.waiting=false})};d.toggleAutostart=function(j,i){var k=d.info["service."+i]["autostart"];f.post("/operation/chkconfig",{name:j,service:i,autostart:!k},function(l){d.loadInfo()})};var b=function(i){return function(k,j){c.call(d,e,"/backend/service_"+i,"/backend/service_"+i+"_"+j,{name:k,service:j},d.loadInfo)}};d.start=b("start");d.stop=b("stop");d.restart=b("restart")}];var ServiceNginxCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.nginx";e.init(c,"Nginx");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.nginx",function(g){var h=g["service.nginx"];if(h){b.installed=true;b.autostart=h.autostart;b.status=h.status;if(b.checkVersion){b.checkVersion()}b.getsettings();b.getcachesettings()}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false});d.get("/client/ip",function(g){b.ip=g})};b.setting={limit_rate:"",limit_conn:"",limit_conn_zone:"",client_max_body_size:"",keepalive_timeout:"",access_status:"off",allow:"",deny:"",gzip:""};b.getsettings=function(){if(!b.installed){return}d.post("/operation/nginx",{action:"gethttpsettings",items:"limit_rate,limit_conn,limit_conn_zone,client_max_body_size,keepalive_timeout,allow[],deny[],gzip"},function(h){if(h.code==0){b.setting=h.data;var g=b.setting;if(g.allow&&g.allow.length>0){g.access_status="white"}else{if(g.deny&&g.deny.length>0){g.access_status="black"}else{g.access_status="off"}}if(g.allow){g.allow=g.allow.join("\n")}if(g.deny){g.deny=g.deny.join("\n")}}},false,true)};b.savesettings=function(){var g=angular.copy(b.setting);g.action="sethttpsettings";g.version=b.pkginfo.version;d.post("/operation/nginx",g,function(h){if(h.code==0){b.getsettings()}})};var f={name:"newcache",mem:"10",path:"/var/www/cache",path_level_1:"1",path_level_2:"2",path_level_3:"0",inactive:"10",inactive_unit:"m",max_size:"100",max_size_unit:"m",autocreate:true};b.proxy_caches=[];b.curcache=-1;b.setcache=function(g){b.curcache=g};b.getcachesettings=function(){if(!b.installed){return}d.post("/operation/nginx",{action:"gethttpsettings",items:"proxy_cache_path[]"},function(h){if(h.code==0){b.proxy_caches=[];var k=h.data.proxy_cache_path;if(k){for(var g=0;g<k.length;g++){var j=angular.copy(f);angular.extend(j,k[g]);b.proxy_caches.push(j)}b.curcache=0}}},false,true)};b.deletecache=function(g){b.proxy_caches.splice(g,1);b.curcache--;if(b.curcache<0&&b.proxy_caches.length>0){b.curcache=0}};b.addcache=function(){var g=b.proxy_caches;g.splice(b.curcache+1,0,angular.copy(f));b.curcache++};b.selectcachefolder=function(g){b.selector_title="请选择缓存目录";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.proxy_caches[g].path);b.selector.selecthandler=function(h){$("#selector").modal("hide");b.proxy_caches[g].path=h};$("#selector").modal()};b.savecaches=function(){var g={action:"setproxycachesettings",proxy_caches:angular.toJson(b.proxy_caches)};d.post("/operation/nginx",g,function(h){if(h.code==0){b.getcachesettings()}})}}];var ServiceApacheCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.apache";e.init(c,"Apache");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.httpd",function(f){var g=f["service.httpd"];if(g){b.installed=true;b.autostart=g.autostart;b.status=g.status;if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})}}];var ServiceVsftpdCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.vsftpd";e.init(c,"vsftpd");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.vsftpd",function(f){var g=f["service.vsftpd"];if(g){b.installed=true;b.autostart=g.autostart;b.status=g.status;if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})}}];var ServiceMySQLCtrl=["$scope","$routeParams","Module","Message","Request","Backend",function(c,a,g,f,e,b){var d="service.mysqld";g.init(d,"MySQL");g.initSection("base");c.scope=c;c.info=null;c.loaded=false;c.installed=false;c.waiting=true;c.checking=false;c.processing=false;c.checkInstalled=function(){c.checking=true;e.get("/query/service.mysqld",function(h){var i=h["service.mysqld"];if(i){c.installed=true;c.autostart=i.autostart;c.status=i.status;if(c.checkVersion){c.checkVersion()}}else{c.installed=false}c.loaded=true;c.waiting=false;c.checking=false})};c.updatepwd=function(){if(c.status!="running"){f.setError("MySQL还未启动，无法修改密码！");return}c.processing=true;e.post("/operation/mysql",{action:"updatepwd",newpassword:c.root_passwd,newpasswordc:c.root_passwdc,password:c.root_opasswd},function(h){if(h.code==0){c.root_passwd="";c.root_passwdc="";c.root_opasswd=""}c.processing=false})};c.fupdatepwd=function(){c.processing=true;b.call(c,d,"/backend/mysql_fupdatepwd","/backend/mysql_fupdatepwd",{password:c.root_passwd,passwordc:c.root_passwdc},function(h){if(h.code==0){c.root_passwd="";c.root_passwdc=""}c.processing=false})}}];var ServiceRedisCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.redis";e.init(c,"Redis");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.redis",function(f){var g=f["service.redis"];if(g){b.installed=true;b.autostart=g.autostart;b.status=g.status;if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})}}];var ServiceMemcacheCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.memcache";e.init(c,"Memcache");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.memcached",function(f){var g=f["service.memcached"];if(g){b.installed=true;b.autostart=g.autostart;b.status=g.status;if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})}}];var ServiceMongoDBCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.mongodb";e.init(c,"MongoDB");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.mongod",function(f){var g=f["service.mongod"];if(g){b.installed=true;b.autostart=g.autostart;b.status=g.status;if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})}}];var ServicePHPCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.php";e.init(c,"PHP");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.php-fpm",function(g){var h=g["service.php-fpm"];if(h){b.installed=true;b.autostart=h.autostart;b.status=h.status;if(b.checkVersion){b.checkVersion()}b.getphpsettings();b.getfpmsettings()}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})};b.setting={php:{short_open_tag:false,expose_php:false,max_execution_time:"",memory_limit:"",display_errors:false,post_max_size:"",upload_max_filesize:"","date.timezone":""},fpm:{listen:"",pm:false,"pm.max_children":"","pm.start_servers":"","pm.min_spare_servers":"","pm.max_spare_servers":"","pm.max_requests":"",request_terminate_timeout:"",request_slowlog_timeout:""}};var f=function(g){g=parseInt(g);if(isNaN(g)){g=""}else{g+=""}return g};b.getphpsettings=function(){if(!b.installed){return}d.post("/operation/php",{action:"getphpsettings"},function(h){if(h.code==0){var g=h.data;var i=b.setting.php;i.short_open_tag=(g.short_open_tag&&g.short_open_tag.toLowerCase()=="on");i.expose_php=(g.expose_php&&g.expose_php.toLowerCase()=="on");i.max_execution_time=g.max_execution_time?g.max_execution_time:"";i.memory_limit=g.memory_limit?f(g.memory_limit):"";i.display_errors=(g.display_errors&&g.display_errors.toLowerCase()=="on");i.post_max_size=g.post_max_size?f(g.post_max_size):"";i.upload_max_filesize=g.upload_max_filesize?f(g.upload_max_filesize):"";i["date.timezone"]=g["date.timezone"]?g["date.timezone"]:""}},false,true)};b.getfpmsettings=function(){if(!b.installed){return}d.post("/operation/php",{action:"getfpmsettings"},function(h){if(h.code==0){var g=h.data;var i=b.setting.fpm;i.listen=g.listen?g.listen:"";i.pm=(g.pm&&g.pm.toLowerCase()=="dynamic");i["pm.max_children"]=g["pm.max_children"]?f(g["pm.max_children"]):"";i["pm.start_servers"]=g["pm.start_servers"]?f(g["pm.start_servers"]):"";i["pm.min_spare_servers"]=g["pm.min_spare_servers"]?f(g["pm.min_spare_servers"]):"";i["pm.max_spare_servers"]=g["pm.max_spare_servers"]?f(g["pm.max_spare_servers"]):"";i["pm.max_requests"]=g["pm.max_requests"]?f(g["pm.max_requests"]):"";i.request_terminate_timeout=g.request_terminate_timeout?f(g.request_terminate_timeout):"";i.request_slowlog_timeout=g.request_slowlog_timeout?f(g.request_slowlog_timeout):""}},false,true)};b.updatephpsettings=function(){var g=angular.copy(b.setting.php);g.action="updatephpsettings";d.post("/operation/php",g,b.getphpsettings)};b.updatefpmsettings=function(){var g=angular.copy(b.setting.fpm);g.action="updatefpmsettings";d.post("/operation/php",g,b.getfpmsettings)}}];var ServiceSendmailCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.sendmail";e.init(c,"Sendmail");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.sendmail",function(f){var g=f["service.sendmail"];if(g){b.installed=true;b.autostart=g.autostart;b.status=g.status;if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})}}];var ServiceSSHCtrl=["$scope","$routeParams","Module","Request","Backend","Message",function(c,a,g,f,b,e){var d="service.ssh";g.init(d,"SSH");g.initSection("base");c.scope=c;c.info=null;c.loaded=false;c.installed=false;c.waiting=true;c.checking=false;c.checkInstalled=function(){c.checking=true;f.get("/query/service.sshd",function(h){var i=h["service.sshd"];if(i){c.installed=true;c.autostart=i.autostart;c.status=i.status;c.getsettings();if(c.checkVersion){c.checkVersion()}}else{c.installed=false}c.loaded=true;c.waiting=false;c.checking=false})};c.setting={};c.getsettings=function(){if(!c.installed){return}f.post("/operation/ssh",{action:"getsettings"},function(h){if(h.code==0){c.setting=h.data;c.setting.disable_pwdauth=!c.setting.enable_pwdauth}},false,true)};c.savesettings=function(){var h={};h.action="savesettings";h.port=c.setting.port;h.enable_pwdauth=c.setting.enable_pwdauth;h.enable_sftp=c.setting.enable_sftp;f.post("/operation/ssh",h,function(i){if(i.code==0){c.getsettings()}})};c.savepksettings=function(){var h={};h.action="savesettings";h.pubkey=c.setting.pubkey;h.enable_pubkauth=c.setting.enable_pubkauth;h.enable_pwdauth=!c.setting.disable_pwdauth;f.post("/operation/ssh",h,function(i){if(i.code==0){c.getsettings()}})};c.gensshkey=function(){if(c.setting.pubkey||c.setting.prvkey){c.confirm_title="重新生成公钥/私钥对";c.confirm_body="公钥/私钥已存在，是否覆盖原文件？";$("#confirm").modal();c.confirm=c.dogenkey;return}c.dogenkey()};c.dogenkey=function(){b.call(c,d,"/backend/ssh_genkey","/backend/ssh_genkey",{},{success:function(h){c.getsettings()}})};c.chpasswd=function(){$("#chpasswd").modal()};c.dochpasswd=function(){if(c.newpassword!=c.newpasswordc){e.setError("新密码和确认密码不一致！");return}b.call(c,d,"/backend/ssh_chpasswd","/backend/ssh_chpasswd",{path:c.setting.prvkey,oldpassword:c.oldpassword,newpassword:c.newpassword},{success:function(h){c.oldpassword=c.newpassword=c.newpasswordc=""}})}}];var ServiceIPTablesCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.iptables";e.init(c,"IPTables");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.iptables",function(f){var g=f["service.iptables"];if(g){b.installed=true;b.autostart=g.autostart;b.status=g.status;if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})}}];var ServiceCronCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.cron";e.init(c,"Cron");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.crond",function(f){var g=f["service.crond"];if(g){b.installed=true;b.autostart=g.autostart;b.status=g.status;if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})}}];var ServiceNTPCtrl=["$scope","$routeParams","Module","Request",function(b,a,e,d){var c="service.ntp";e.init(c,"NTP");e.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;d.get("/query/service.ntpd",function(f){var g=f["service.ntpd"];if(g){b.installed=true;b.autostart=g.autostart;b.status=g.status;if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})}}];var releasetime="2012-11-07 18:00:13 CST";var _v=new Date(releasetime.replace(/-/g,"/")).getTime()/1000;angular.module("vpsmate",["vpsmate.services","vpsmate.directives","vpsmate.filters"]).config(["$routeProvider",function(a){var b=function(e,g,d){var f={templateUrl:template_path+"/partials/"+e+".html?_v="+_v,controller:g,reloadOnSearch:false};if(!d){f.resolve=Auth}return f};a.when("/",b("login",LoginCtrl,true)).when("/main",b("main",MainCtrl)).when("/service/nginx",b("service/nginx",ServiceNginxCtrl)).when("/service/apache",b("service/apache",ServiceApacheCtrl)).when("/service/vsftpd",b("service/vsftpd",ServiceVsftpdCtrl)).when("/service/mysql",b("service/mysql",ServiceMySQLCtrl)).when("/service/redis",b("service/redis",ServiceRedisCtrl)).when("/service/memcache",b("service/memcache",ServiceMemcacheCtrl)).when("/service/mongodb",b("service/mongodb",ServiceMongoDBCtrl)).when("/service/php",b("service/php",ServicePHPCtrl)).when("/service/sendmail",b("service/sendmail",ServiceSendmailCtrl)).when("/service/ssh",b("service/ssh",ServiceSSHCtrl)).when("/service/iptables",b("service/iptables",ServiceIPTablesCtrl)).when("/service/cron",b("service/cron",ServiceCronCtrl)).when("/service/ntp",b("service/ntp",ServiceNTPCtrl)).when("/service",b("service/index",ServiceCtrl)).when("/file",b("file/file",FileCtrl)).when("/file/go#(:path)",b("file/file",FileCtrl)).when("/file/trash",b("file/trash",FileTrashCtrl)).when("/site",b("site/index",SiteCtrl)).when("/site/nginx/:section",b("site/nginx/site",SiteNginxCtrl)).when("/database",b("database/index",DatabaseCtrl)).when("/database/mysql/db/new",b("database/mysql/dbnew",DatabaseMySQLNewDBCtrl)).when("/database/mysql/db/edit/:section",b("database/mysql/dbedit",DatabaseMySQLEditDBCtrl)).when("/database/mysql/user/new",b("database/mysql/usernew",DatabaseMySQLNewUserCtrl)).when("/database/mysql/user/edit/:section",b("database/mysql/useredit",DatabaseMySQLEditUserCtrl)).when("/ftp",b("ftp",FtpCtrl)).when("/task",b("task",TaskCtrl)).when("/utils",b("utils/index",UtilsCtrl)).when("/utils/user",b("utils/user",UtilsUserCtrl)).when("/utils/network",b("utils/network",UtilsNetworkCtrl)).when("/utils/time",b("utils/time",UtilsTimeCtrl)).when("/utils/partition",b("utils/partition",UtilsPartitionCtrl)).when("/utils/autofm",b("utils/autofm",UtilsAutoFMCtrl)).when("/utils/movedata",b("utils/movedata",UtilsMoveDataCtrl)).when("/setting",b("setting",SettingCtrl)).when("/logout",b("logout",LogoutCtrl)).when("/sorry",b("sorry",SorryCtrl)).otherwise({redirectTo:"/sorry"})}]).run(["$rootScope","$location","Request",function(a,c,b){a.sec=function(d){c.search("s",d)};a.virt="?";a.checkVirt=function(d){if(a.virt!="?"){return}b.get("/query/server.virt",function(e){a.virt=e["server.virt"];if(d){d.call()}})};a.$mysql={password:"",password_validated:false};a.$proxyroot=location_path}]).value("version",{version:"1.0",build:"7",releasetime:releasetime,changelog:"http://www.vpsmate.org/changelog"});var Auth={auth:function(b,d,c){var a=b.defer();c.setInfo("正在加载，请稍候...",true);d.required(function(e){c.setInfo(false);if(e){a.resolve()}},function(e){if(e==403){c.setError('身份认证失败，请<a href="#/">重新登录</a>！')}else{c.setError("对不起，加载失败！（网络异常或服务器故障）")}});return a.promise},auto_auth:function(a,h,c,d){if(!a._auth_check_inited){a._auth_check_inited=true;var e=300*1000;var b=2500*1000;var f=new Date().getTime();$(document).mousemove(function(){f=new Date().getTime()});$(document).keydown(function(){f=new Date().getTime()});var g=(function(){var j=false;var i=new Date().getTime();if(i-f<e){c.required()}else{if(i-f>b){j=true;c.getlastactive(function(k){k=parseInt(k)*1000;if(i-k>b){var n=a.htmlTitle;var m=["登录超时","!!!!!!!!"];var l=0;var p=false;var o=function(){if(!p){a.htmlTitle=m[(l++)%2];d(o,1000,false,true,"_authtimeout_title")}else{a.htmlTitle=n}};o();a._authrenew=function(){f=new Date().getTime();p=true;c.required();d(g,e,false,true,"_authtimeout")};$("#_authconfirm").modal()}else{f=k;d(g,e,false,true,"_authtimeout")}})}}if(!j&&h.path()!="/"){d(g,e,false,true,"_authtimeout")}});d(g,e,false,true,"_authtimeout")}}};Auth.auth.$inject=["$q","Auth","Message"];Auth.auto_auth.$inject=["$rootScope","$location","Auth","Timeout"];var getCookie=function(a){var b=document.cookie.match("\\b"+a+"=([^;]*)\\b");return b?b[1]:undefined};angular.module("vpsmate.directives",[]).directive("navbar",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope","$rootScope",function(b,a){a.navbar_loaded=true}],template:'<div class="navbar">				<div class="navbar-inner">					<div class="container">						<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">							<span class="icon-bar"></span>							<span class="icon-bar"></span>							<span class="icon-bar"></span>						</button>						<a class="brand" href="#/main">VPSMate</a>						<div class="nav-collapse collapse">							<ul class="nav">								<li ng-class="\'active\' | ifmatch:[currentItem,\'main\']"><a href="#/main">首页</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'service(..*)?\']"><a href="#/service">服务管理</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'file\']"><a href="#/file">文件管理</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'site(..*)?\']"><a href="#/site">网站管理</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'database\']"><a href="#/database">数据库管理</a></li>								<!--<li ng-class="\'active\' | ifmatch:[currentItem,\'ftp\']"><a href="#/ftp">FTP管理</a></li>-->								<!--<li ng-class="\'active\' | ifmatch:[currentItem,\'secure\']"><a href="#/secure">安全管理</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'backup\']"><a href="#/backup">备份管理</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'log\']"><a href="#/log">日志管理</a></li>-->								<li ng-class="\'active\' | ifmatch:[currentItem,\'task\']"><a href="#/task">计划任务</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'utils(..*)?\']"><a href="#/utils">系统工具</a></li>							</ul>							<ul class="nav pull-right">								<li ng-class="\'active\' | ifmatch:[currentItem,\'setting(..*)?\']"><a href="#/setting">设置</a></li>								<li class="divider-vertical"></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'logout\']"><a href="#/logout">退出</a></li>							</ul>						</div>					</div>				</div>			</div>',replace:true}}).directive("loading",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope",function(a){if(!a.loadingText){a.loadingText="模块加载中，请稍候......"}}],template:'<div style="padding:30px 0 10px 30px;">			<h6>{{loadingText}}</h6>			<div class="progress progress-striped active" style="width:230px">			<div class="bar" style="width:100%;"></div>			</div></div>',replace:true}}).directive("message",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope","$rootScope",function(b,a){a.showErrorMsg=false;a.errorMessage="";a.showSuccessMsg=false;a.successMessage="";a.showWarningMsg=false;a.warningMessage="";a.showInfoMsg=false;a.infoMessage="";b.$rootScope=a;if(!b.id){b.id="message"}}],template:'<div id="{{id}}" style="position:fixed;left:0;bottom:0;width:100%;z-index:100">			<div class="container">				<div class="alert alert-error" style="display:none;margin-bottom:3px" ng-show="$rootScope.showErrorMsg">				<button ng-click="$rootScope.showErrorMsg=false" type="button" class="close">&times;</button>				<span ng-bind-html-unsafe="$rootScope.errorMessage"></span></div>				<div class="alert alert-success" style="display:none;margin-bottom:3px" ng-show="$rootScope.showSuccessMsg">				<button ng-click="$rootScope.showSuccessMsg=false" type="button" class="close">&times;</button>				<span ng-bind-html-unsafe="$rootScope.successMessage"></span></div>				<div class="alert alert-warning" style="display:none;margin-bottom:3px" ng-show="$rootScope.showWarningMsg">				<button ng-click="$rootScope.showWarningMsg=false" type="button" class="close">&times;</button>				<span ng-bind-html-unsafe="$rootScope.warningMessage"></span></div>				<div class="alert alert-info" style="display:none;margin-bottom:3px" ng-show="$rootScope.showInfoMsg">				<button ng-click="$rootScope.showInfoMsg=false" type="button" class="close">&times;</button>				<span ng-bind-html-unsafe="$rootScope.infoMessage"></span></div>			</div>			</div>',replace:true}}).directive("srvminiop",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope",function(a){a.$scope=a.$parent}],template:'<div><div class="btn-group" ng-show="$scope.info[\'service.\'+service]">					<button class="btn btn-small" ng-class="\'active\' | iftrue:$scope.info[\'service.\'+service].autostart" data-toggle="button" title="自动启动"						ng-disabled="$scope.waiting" ng-click="$scope.toggleAutostart(name, service)">						<i class="icon-check"></i>					</button>					<button class="btn btn-small" ng-show="$scope.info[\'service.\'+service].status==\'stopped\'" title="启动" ng-disabled="$scope.waiting"						ng-click="$scope.start(name, service)">						<i class="icon-play"></i>					</button>					<button class="btn btn-small" ng-show="$scope.info[\'service.\'+service].status==\'running\'" title="停止" ng-disabled="$scope.waiting"						ng-click="$scope.stop(name, service)">						<i class="icon-stop"></i>					</button>					<button class="btn btn-small" ng-disabled="$scope.info[\'service.\'+service].status==\'stopped\'||$scope.waiting" title="重启"						ng-click="$scope.restart(name, service)">						<i class="icon-refresh"></i>					</button>					<a class="btn btn-small" href="#/service/{{urlname}}" ng-show="$scope.info[\'service.\'+service]!=null" title="设置">						<i class="icon-wrench"></i>					</a>				</div>				<a class="btn btn-small" href="#/service/{{urlname}}" ng-show="!$scope.info[\'service.\'+service]">安装服务</a></div>',replace:true}}).directive("srvbase",function(){return{restrict:"A",transclude:true,scope:{},controller:["$rootScope","$scope","Request","Backend",function(a,d,e,c){d.$scope=d.$parent;d.pkginfo=null;d.$parent.checkVersion=function(){c.call(d.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+d.pkg,{pkg:d.pkg,repo:"installed"},{success:function(f){d.$parent.pkginfo=d.pkginfo=f.data[0]},error:function(f){d.pkginfo={name:"获取失败！"}}},true)};d.toggleAutostart=function(){e.post("/operation/chkconfig",{name:d.name,service:d.service,autostart:!d.$parent.autostart},function(f){d.$parent.checkInstalled()})};var b=function(f){return function(){c.call(d.$parent,a.module,"/backend/service_"+f,"/backend/service_"+f+"_"+d.service,{name:d.name,service:d.service},d.$parent.checkInstalled)}};d.start=b("start");d.stop=b("stop");d.restart=b("restart")}],template:'<table class="table table-button" style="width:400px;">				<thead>					<tr>						<th colspan="2">{{name}} 服务操作</th>					</tr>				</thead>				<tbody>					<tr>						<td style="width:120px;">当前软件版本：</td>						<td>							<span ng-show="!pkginfo">正在获取...</span>							<span style="display:none" ng-show="pkginfo">							{{pkginfo.name}} {{\'v\'+pkginfo.version | iftrue:pkginfo.version}} {{"("+pkginfo.from_repo+")" | iftrue:pkginfo.from_repo}}							</span>						</td>					</tr>					<tr>						<td style="width:120px;">当前服务状态：</td>						<td ng-bind-html-unsafe="$scope.status | service.status"></td>					</tr>					<tr>						<td>开机是否启动：</td>						<td>							<button class="btn btn-small" ng-class="\'active\' | iftrue:$scope.autostart" data-toggle="button"								ng-click="toggleAutostart()">								<i class="icon-check"></i> 开机自动启动							</button>						</td>					</tr>					<tr>						<td>启动/停止服务：</td>						<td>							<button class="btn btn-small" ng-show="$scope.status==\'stopped\'" ng-disabled="$scope.waiting"								ng-click="start()">								<i class="icon-play"></i> 启动服务							</button>							<button class="btn btn-small" ng-show="$scope.status==\'running\'" ng-disabled="$scope.waiting"								ng-click="stop()">								<i class="icon-stop"></i> 停止服务							</button>							<button class="btn btn-small" ng-disabled="$scope.status==\'stopped\'||$scope.waiting"								ng-click="restart()">								<i class="icon-refresh"></i> 重启服务							</button>						</td>					</tr>				</tbody>				</table>',replace:true}}).directive("srvinstall",function(){return{restrict:"A",transclude:true,scope:{},controller:["$rootScope","$scope","Request","Timeout","Backend",function(a,c,d,f,b){c.$scope=c.$parent;var e=[];c.installing=false;c.installMsg="";c.startInstall=function(){c.installMsg="正在检测软件源...";c.installing=true;b.call(c.$parent,a.module,"/backend/yum_repolist","/backend/yum_repolist",{},{wait:function(g){c.installMsg=g.msg},success:function(g){c.installMsg=g.msg;e=g.data;c.installRepo()},error:function(g){c.installMsg=g.msg;f(function(){c.installing=false},3000,a.module)}},true)};c.installRepo=function(){var h=false;for(var l=0;l<c.expected_repolist.length;l++){var g=false;for(var k=0;k<e.length;k++){if(e[k]==c.expected_repolist[l]){g=true;break}}if(g){continue}h=true;b.call(c.$parent,a.module,"/backend/yum_installrepo","/backend/yum_installrepo_"+c.expected_repolist[l],{repo:c.expected_repolist[l]},{wait:function(i){c.installMsg=i.msg},success:function(i){c.installMsg=i.msg;e.push(c.expected_repolist[l]);c.installRepo()},error:function(i){c.installMsg=i.msg;f(function(){c.installing=false},3000,a.module)}},true);break}if(!h){c.checkVersion()}};c.showVerList=false;c.checkVersion=function(){b.call(c.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+c.pkg,{pkg:c.pkg},{wait:function(g){c.installMsg=g.msg},success:function(g){c.installMsg=g.msg;c.pkgs=g.data;c.showVerList=true},error:function(g){c.installMsg=g.msg;f(function(){c.installing=false},3000,a.module)}},true)};c.install=function(i,h,g){c.installMsg="开始安装...";c.showVerList=false;b.call(c.$parent,a.module,"/backend/yum_install","/backend/yum_install_"+i+"_"+h+"_"+g,{repo:i,pkg:h,version:g},{wait:function(j){c.installMsg=j.msg},success:function(j){c.installMsg=j.msg;c.$parent.activeTabName="base";f(function(){c.installing=false;c.$parent.checkInstalled()},3000,a.module)},error:function(j){c.installMsg=j.msg;f(function(){c.installing=false},3000,a.module)}},true)};c.uninstall=function(i,h,g){c.installMsg="正在清理...";c.showVerList=false;b.call(c.$parent,a.module,"/backend/yum_uninstall","/backend/yum_uninstall_"+h+"_"+g,{repo:i,pkg:h,version:g},{wait:function(j){c.installMsg=j.msg},success:function(j){c.installMsg=j.msg;f(function(){c.installing=false;c.$parent.checkInstalled()},3000,a.module)},error:function(j){c.installMsg=j.msg;f(function(){c.installing=false},3000,a.module)}},true)}}],template:'<div class="well" style="width:450px;display:none" ng-show="!$scope.installed&&!$scope.checking">				<div ng-show="!installing">					<p>系统检测到 {{name}} 当前尚未安装。</p>					<p>是否要开始安装？</p>				</div>				<div ng-show="installing" ng-bind-html-unsafe="installMsg"></div>				<p ng-show="!installing"><button class="btn btn-small" style="margin-top:10px" ng-click="startInstall()">开始安装</button></p>				<table class="table table-condensed" style="margin-top:20px;display:none" ng-show="showVerList&&pkgs.length>0">					<thead>						<tr>							<th>版本</th>							<th style="width:70px">大小</th>							<th style="width:70px">软件源</th>							<th style="width:80px"></th>						</tr>					</thead>					<tbody>						<tr ng-repeat="pkg in pkgs">							<td>{{pkg.name}} v{{pkg.version}}</td>							<td>{{pkg.size}}</td>							<td>{{\'已安装\'|iftrue:pkg.repo==\'installed\'}}{{pkg.repo|iftrue:pkg.repo!=\'installed\'}}</td>							<td>								<button class="btn btn-mini" ng-show="pkg.repo==\'installed\'" ng-click="uninstall(pkg.repo, pkg.name, pkg.version)">清除此版本</button>								<button class="btn btn-mini" ng-show="pkg.repo!=\'installed\'" ng-click="install(pkg.repo, pkg.name, pkg.version)">安装此版本</button>							</td>						</tr>					</tbody>				</table>			</div>',replace:true}}).directive("srvupdate",function(){return{restrict:"A",transclude:true,scope:{},controller:["$rootScope","$scope","Request","Timeout","Backend",function(a,c,d,e,b){c.$scope=c.$parent;c.updating=false;c.updateMsg="";c.startUpdate=function(){c.updating=true;c.updateMsg="正在检测当前版本信息...";b.call(c.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+c.pkg,{pkg:c.pkg,repo:"installed"},{wait:function(f){c.updateMsg=f.msg},success:function(f){c.updateMsg=f.msg;c.pkginfo=f.data[0];c.checkVersion(c.pkginfo.name)},error:function(f){c.updateMsg=f.msg;e(function(){c.updating=false},3000,a.module)}},true)};c.showVerList=false;c.checkVersion=function(f){c.updateMsg="正在检测新版本...";b.call(c.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+f,{pkg:f,option:"update"},{wait:function(g){c.updateMsg=g.msg},success:function(g){c.updateMsg=g.msg;c.pkgs=g.data;c.showVerList=true},error:function(g){c.updateMsg=g.msg;e(function(){c.updating=false},3000,a.module)}},true)};c.update=function(h,g,f){c.updateMsg="开始升级...";c.showVerList=false;b.call(c.$parent,a.module,"/backend/yum_update","/backend/yum_update_"+g,{repo:h,pkg:g,version:f},{wait:function(i){c.updateMsg=i.msg},success:function(i){c.updateMsg=i.msg;c.$parent.activeTabName="base";e(function(){c.updating=false;c.$parent.checkInstalled()},3000,a.module)},error:function(i){c.updateMsg=i.msg;e(function(){c.updating=false},3000,a.module)}},true)}}],template:'<div class="well" style="width:450px;display:none" ng-show="$scope.installed&&!$scope.checking">				<div ng-show="!updating">					<p>在此检测并查找可用的新版本并升级。</p>				</div>				<div ng-show="updating" ng-bind-html-unsafe="updateMsg"></div>				<p ng-show="!updating"><button class="btn btn-small" style="margin-top:10px" ng-click="startUpdate()">检测新版本</button></p>				<table class="table table-condensed" style="margin-top:20px;display:none" ng-show="showVerList&&pkgs.length>0">					<thead>						<tr>							<th>版本</th>							<th style="width:70px">大小</th>							<th style="width:70px">软件源</th>							<th style="width:90px"></th>						</tr>					</thead>					<tbody>						<tr ng-repeat="pkg in pkgs">							<td>{{pkg.name}} v{{pkg.version}}</td>							<td>{{pkg.size}}</td>							<td>{{\'已安装\'|iftrue:pkg.repo==\'installed\'}}{{pkg.repo|iftrue:pkg.repo!=\'installed\'}}</td>							<td>								<button class="btn btn-mini" ng-show="pkg.repo!=\'installed\'" ng-click="update(pkg.repo, pkg.name, pkg.version)">升级到此版本</button>							</td>						</tr>					</tbody>				</table>			</div>',replace:true}}).directive("srvext",function(){return{restrict:"A",transclude:true,scope:{},controller:["$rootScope","$scope","Request","Timeout","Backend",function(a,c,d,e,b){c.$scope=c.$parent;c.operating=false;c.showMsg="";c.start=function(){c.operating=true;c.showMsg="正在检测版本信息...";b.call(c.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+c.pkg,{pkg:c.pkg,repo:"installed"},{wait:function(f){c.showMsg=f.msg},success:function(f){c.showMsg=f.msg;c.pkginfo=f.data[0];c.checkExt()},error:function(f){c.showMsg=f.msg;e(function(){c.operating=false},3000,a.module)}},true)};c.showExtList=false;c.checkExt=function(){c.operating=true;c.showExtList=false;c.showMsg="正在检测扩展...";b.call(c.$parent,a.module,"/backend/yum_ext_info","/backend/yum_ext_info_"+c.pkginfo.name,{pkg:c.pkginfo.name},{wait:function(f){c.showMsg=f.msg},success:function(f){c.showMsg=f.msg;c.exts=f.data;c.showExtList=true},error:function(f){c.showMsg=f.msg;e(function(){c.operating=false},3000,a.module)}},true)};c.install=function(h,g,f){c.showMsg="开始安装...";c.showExtList=false;b.call(c.$parent,a.module,"/backend/yum_install","/backend/yum_install_"+h+"_"+c.pkginfo.name+"_"+g+"_"+f,{repo:h,pkg:c.pkginfo.name,ext:g,version:f},{wait:function(i){c.showMsg=i.msg},success:function(i){c.showMsg=i.msg;e(function(){c.operating=false;c.checkExt()},3000,a.module)},error:function(i){c.showMsg=i.msg;e(function(){c.operating=false},3000,a.module)}},true)};c.uninstall=function(h,g,f){c.showMsg="正在删除...";c.showExtList=false;b.call(c.$parent,a.module,"/backend/yum_uninstall","/backend/yum_uninstall_"+c.pkginfo.name+"_"+g+"_"+f,{repo:h,pkg:c.pkginfo.name,ext:g,version:f},{wait:function(i){c.showMsg=i.msg},success:function(i){c.showMsg=i.msg;e(function(){c.operating=false;c.checkExt()},3000,a.module)},error:function(i){c.showMsg=i.msg;e(function(){c.operating=false},3000,a.module)}},true)}}],template:'<div class="well" style="width:450px;display:none" ng-show="$scope.installed&&!$scope.checking">				<div ng-show="!operating">					<p>点击下面的按钮检测扩展安装情况。</p>				</div>				<div ng-show="operating" ng-bind-html-unsafe="showMsg"></div>				<p ng-show="!operating"><button class="btn btn-small" style="margin-top:10px" ng-click="start()">检测扩展</button></p>				<table class="table table-condensed" style="margin-top:20px;display:none" ng-show="showExtList&&exts.length>0">					<thead>						<tr>							<th>扩展名称</th>							<th>版本</th>							<th style="width:70px">软件源</th>							<th style="width:90px"></th>						</tr>					</thead>					<tbody>						<tr ng-repeat="ext in exts">							<td>{{ext.name}}</td>							<td>{{ext.version}}</td>							<td>{{\'已安装\'|iftrue:ext.repo==\'installed\'}}{{ext.repo|iftrue:ext.repo!=\'installed\'}}</td>							<td>								<button class="btn btn-mini" ng-show="ext.repo==\'installed\'" ng-click="uninstall(ext.repo, ext.name, ext.version)">删除扩展</button>								<button class="btn btn-mini" ng-show="ext.repo!=\'installed\'" ng-click="install(ext.repo, ext.name, ext.version)">安装该扩展</button>							</td>						</tr>					</tbody>				</table>			</div>',replace:true}}).directive("srvuninstall",function(){return{restrict:"A",transclude:true,scope:{},controller:["$rootScope","$scope","Request","Timeout","Backend",function(a,c,d,e,b){c.$scope=c.$parent;c.uninstalling=false;c.uninstallMsg="";c.startUninstall=function(){c.uninstallMsg="开始卸载...";c.uninstalling=true;b.call(c.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+c.pkg,{pkg:c.pkg,repo:"installed"},{wait:function(f){c.uninstallMsg=f.msg},success:function(f){c.uninstallMsg=f.msg;c.pkginfo=f.data[0];c.showVersion=true},error:function(f){c.uninstallMsg=f.msg;e(function(){c.uninstalling=false},3000,a.module)}},true)};c.uninstall=function(h,g,f){c.uninstallMsg="正在卸载...";c.showVersion=false;b.call(c.$parent,a.module,"/backend/yum_uninstall","/backend/yum_uninstall_"+g+"_"+f,{repo:h,pkg:g,version:f},{wait:function(i){c.uninstallMsg=i.msg},success:function(i){c.uninstallMsg=i.msg;e(function(){c.uninstalling=false;c.$parent.checkInstalled()},3000,a.module)},error:function(i){c.uninstallMsg=i.msg;e(function(){c.uninstalling=false},3000,a.module)}},true)}}],template:'<div class="well" style="width:450px;" ng-show="$scope.installed&&!$scope.checking">				<div ng-show="!uninstalling">					<p>确定要卸载 {{name}} 吗？</p>				</div>				<div ng-show="uninstalling" ng-bind-html-unsafe="uninstallMsg"></div>				<p ng-show="!uninstalling"><button class="btn btn-small" style="margin-top:10px" ng-click="startUninstall()">开始卸载</button></p>				<table class="table table-condensed" style="margin-top:20px;display:none" ng-show="showVersion">					<thead>						<tr><th colspan="2">请确认要卸载的软件信息：</th></tr>					</thead>					<tbody>						<tr><td style="width:80px">名称：</td><td>{{pkginfo.name}}</td></tr>						<tr><td>版本：</td><td>{{pkginfo.version}}</td></tr>						<tr><td>大小：</td><td>{{pkginfo.size}}</td></tr>						<tr ng-show="pkginfo.from_repo"><td>软件源：</td><td>{{pkginfo.from_repo}}</td></tr>					</tbody>				</table>				<p ng-show="showVersion"><button class="btn btn-mini" ng-click="uninstall(pkginfo.repo, pkginfo.name, pkginfo.version)">确认并卸载</button>			</div>',replace:true}}).directive("srvfile",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope",function(a){}],template:'			<table class="table table-button" style="width:600px;">				<tbody>					<tr class="warning">						<td colspan="3" class="text-error">注意：如果您没有配置文件修改经验，请勿随意修改，否则可能导致服务无法启动。</td>					</tr>					<tr ng-repeat="item in items">						<td style="width:120px;">{{item.name}}</td>						<td>							<i class="icon-folder-open" ng-show="item.isdir"></i>							<i class="icon-file" ng-show="item.isfile"></i>							{{item.path}}						</td>						<td style="width:100px">							<a class="btn btn-small" href="#/file?path={{item.path}}" ng-show="item.isdir">								打开 <i class="icon-chevron-right"></i>							</a>							<a class="btn btn-small" href="#/file?file={{item.path}}" ng-show="item.isfile">								打开 <i class="icon-chevron-right"></i>							</a>						</td>					</tr>				</tbody>			</table>',replace:true}}).directive("srvlog",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope",function(a){}],template:'			<table class="table table-button" style="width:600px;">				<tbody>					<tr class="warning">						<td colspan="3" class="text-error">注意：尽量不要对日志文件进行修改，否则可能导致新日志无法写入。</td>					</tr>					<tr ng-repeat="item in items">						<td style="width:120px;">{{item.name}}</td>						<td>							<i class="icon-folder-open" ng-show="item.isdir"></i>							<i class="icon-file" ng-show="item.isfile"></i>							{{item.path}}						</td>						<td style="width:100px">							<a class="btn btn-small" href="#/file?path={{item.path}}" ng-show="item.isdir">								打开 <i class="icon-chevron-right"></i>							</a>							<a class="btn btn-small" href="#/file?file={{item.path}}" ng-show="item.isfile">								打开 <i class="icon-chevron-right"></i>							</a>						</td>					</tr>				</tbody>			</table>',replace:true}}).directive("selector",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope","Request",function(b,c){b.$scope=b.$parent;b.onlydir=true;b.onlyfile=true;b.path="/";var a=function(){if(!b.curpath){return}var g=b.curpath.split("/");var f=[];for(var d=1;d<g.length;d++){if(!g[d]){continue}var e=g[d-1]+"/"+g[d];f.push({name:g[d],path:e});g[d]=e}b.pathinfos=f};b.load=function(d){if(b.onlyfile){b.otherdir=true;b.listdir(d)}else{b.otherdir=false;b.path=d}};b.listdir=function(d){if(d){b.path=d}if(!b.path){b.path="/root"}else{if(b.path!="/"&&b.path.substr(-1)=="/"){b.path=b.path.substr(0,b.path.length-1)}}b.path=b.path.replace("//","/");var e=b.path;c.post("/operation/file",{action:"listdir",path:e,showhidden:false,remember:false,onlydir:b.onlydir},function(f){if(f.code==0){b.items=f.data;b.curpath=e;b.lastpath=e;b.curpath_pre=e=="/"?"":e}else{b.path=b.lastpath}a()},false,true)};b.$parent.selector=b}],template:'<div>			<div ng-show="onlydir&&!onlyfile&&!otherdir">				<p>当前目录为：{{path}}</p>				<p>					<button class="btn" ng-click="selecthandler(path)">选择当前目录</button>					<button class="btn" ng-click="otherdir=true;listdir(path)">选择其它目录</button>				</p>			</div>			<div ng-show="otherdir">			<ul class="breadcrumb" style="margin-bottom:0">				<li><a ng-click="listdir(\'/\')">根目录</a> <span class="divider">/</span></li>				<li ng-repeat="pathinfo in pathinfos" ng-show="pathinfos.length>0"><a ng-click="listdir(pathinfo.path)">{{pathinfo.name}}</a> <span class="divider">/</span></li>				<li><button class="btn btn-mini" ng-show="onlydir" ng-click="selecthandler(curpath)">选取该目录</button></li>			</ul>			<table class="table table-condensed table-hover">				<thead>					<tr>						<th></th>						<th style="width:80px"></th>					</tr>				</thead>				<tbody>					<tr ng-repeat="item in items">						<td>							<i class="icon-folder-open" title="文件夹" ng-show="item.isdir"></i>							<i class="icon-file" title="文件" ng-show="item.isreg"></i>							<i class="icon-asterisk" title="链接" ng-show="item.islnk&&(item.link_isdir||item.link_isreg)"></i>							<i class="icon-ban-circle" title="未知" ng-show="!item.isdir&&!item.isreg&&(!item.islnk||(item.islnk&&!item.link_isdir&&!item.link_isreg))"></i>							<a class="black" ng-click="listdir(curpath_pre+\'/\'+item.name)" ng-show="item.isdir||(item.islnk&&item.link_isdir)">{{item.name}}</a>							<a class="black" ng-show="item.isreg||(item.islnk&&!item.link_isdir)">{{item.name}}</a>							<span class="text-info" ng-show="item.islnk">-> {{item.linkto}}</span>						</td>						<td>							<button class="btn btn-mini" ng-show="onlydir&&(item.isdir||(item.islnk&&item.link_isdir))" ng-click="selecthandler(curpath_pre+\'/\'+item.name)">选取该目录</button>							<button class="btn btn-mini" ng-show="onlyfile&&(item.isreg||(item.islnk&&item.link_isreg))" ng-click="selecthandler(curpath_pre+\'/\'+item.name)">选取该文件</button>						</td>					</tr>				</tbody>			</table>			</div>',replace:true}}).directive("autofocus",function(){return function(a,b){b[0].focus()}});angular.module("vpsmate.filters",[]).filter("iftrue",function(){return function(a,b){return b?a:""}}).filter("ifmatch",function(){return function(a,b){return b[0].match(new RegExp("^"+b[1]+"$"))?a:""}}).filter("ifnotmatch",function(){return function(a,b){return b[0].match(new RegExp("^"+b[1]+"$"))?"":a}}).filter("ifin",function(){return function(a,b){return typeof b[1][b[0]]!="undefined"?a:""}}).filter("ifnotin",function(){return function(a,b){return typeof b[1][b[0]]!="undefined"?"":a}}).filter("ifverget",function(){return function(c,e){if(!e[0]||!e[1]){return""}var a=e[0].split(".");var b=e[1].split(".");for(var d=0;d<a.length;d++){if(b.length==d){return c}if(a[d]==b[d]){continue}else{if(a[d]>b[d]){return c}else{return""}}}if(a.length!=b.length){return""}return c}}).filter("urlencode",function(){return function(a){return a?encodeURIComponent(a):""}}).filter("netiface.updown",function(){return function(a){return a=="up"?'<span class="label label-success">启用</span>':'<span class="label label-warning">停用</span>'}}).filter("netiface.encap",function(){return function(a){if(a=="Local Loopback"){return"本地环路"}if(a=="Ethernet"){return"以太网"}if(a=="Point-to-Point Protocol"){return"点对点"}if(a=="UNSPEC"){return"未识别"}return a}}).filter("loadavg.overload",function(){return function(a,c){if(!a){return""}var b=a-c;b=parseInt(b*100/c);if(b<0){return'<span class="label label-success">'+Math.abs(b)+"%空闲</span>"}else{if(b>100){return'<span class="label label-important">'+b+"%过载</span>"}else{return'<span class="label label-warning">'+b+"%过载</span>"}}}}).filter("uptime.idlerate",function(){return function(a){if(!a){return""}var b=parseInt(a);if(b<10){return'<span class="label label-important">'+a+"空闲</span>"}else{if(b<25){return'<span class="label label-warning">'+a+"空闲</span>"}else{return'<span class="label label-success">'+a+"空闲</span>"}}}}).filter("space.used",function(){return function(a){if(!a){return""}var b=parseInt(a);if(b>90){return'<span class="label label-important">'+a+"</span>"}else{if(b>75){return'<span class="label label-warning">'+a+"</span>"}else{return'<span class="label label-success">'+a+"</span>"}}}}).filter("space.free",function(){return function(a){if(!a){return""}var b=parseInt(a);if(b<10){return'<span class="label label-important">'+a+"</span>"}else{if(b<25){return'<span class="label label-warning">'+a+"</span>"}else{return'<span class="label label-success">'+a+"</span>"}}}}).filter("service.status",function(){return function(a){if(!a){return'<span class="label">未安装</span>'}return a=="running"?'<span class="label label-success">运行中</span>':'<span class="label label-important">已停止</span>'}}).filter("user.lock",function(){return function(a){return a?'<span class="label">锁定</span>':'<span class="label label-success">正常</span>'}}).filter("site.status",function(){return function(a){return a=="on"?'<span class="label label-success">启用</span>':'<span class="label label-important">停用</span>'}}).filter("site.engine",function(){return function(a){if(a=="static"){return"静态"}else{if(a=="fastcgi"){return"FastCGI"}else{if(a=="scgi"){return"SCGI"}else{if(a=="uwsgi"){return"uWSGI"}else{if(a=="redirect"){return"跳转"}else{if(a=="rewrite"){return"重写"}else{if(a=="proxy"){return"反代"}else{if(a=="return"){return"错误"}else{return a}}}}}}}}}}).filter("site.port",function(){return function(a){if(a=="80"){return"http"}else{if(a=="443"){return"https"}else{return""}}}}).filter("site.default_server",function(){return function(a){return !a?'<span class="label label-info">默认</span>':""}}).filter("bytes2human",function(){return function(e){var d=["G","M","K"];var a=d.length;var b=[];for(var c=0;c<a;c++){b[c]=1<<(a-c)*10}for(var c=0;c<a;c++){if(e>=b[c]){return Math.round((e/b[c])*10)/10+d[c]}}return e+"B"}}).filter("mysql.user",function(){return function(a){return a==""?'<span class="text-error">任意</span>':a}}).filter("mysql.haspasswd",function(){return function(a){return a=="N"?'<span class="text-error">否</span>':"是"}}).filter("mysql.grant",function(){return function(a){return a=="N"?"否":"是"}}).filter("mysql.privtype",function(){return function(a,b){if(a=="*"||a==""){return"全局指定"}if(a==b){return"按数据库指定"}return"通配符"}}).filter("mysql.privtype_en",function(){return function(a,b){if(a=="*"||a==""){return"global"}if(a==b){return"bydb"}return"wildcard"}}).filter("mysql.privs",function(){return function(a,d){if(!a){return"---"}var f=["Select_priv","Insert_priv","Update_priv","Delete_priv","Create_priv","Alter_priv","Index_priv","Drop_priv","Create_tmp_table_priv","Show_view_priv","Create_routine_priv","Alter_routine_priv","Execute_priv","Create_view_priv","Event_priv","Trigger_priv","Lock_tables_priv","References_priv"];var e=["File_priv","Super_priv","Process_priv","Reload_priv","Shutdown_priv","Show_db_priv","Repl_client_priv","Repl_slave_priv","Create_user_priv"];if(d=="global"){f=f.concat(e)}var c=0;for(var b=0;b<f.length;b++){if(a[f[b]]=="Y"){c++}}if(c==0){return d=="global"?"无全局权限":"无权限"}else{if(c==f.length){return"所有权限"}else{return"部分权限"}}}});