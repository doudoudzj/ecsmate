var SiteCtrl=["$scope","Module","$routeParams","Request","Message","Backend",function(i,b,h,f,a,c){var e="site";b.init(e,"网站管理");i.loaded=false;var g=b.getSection();i.has_httpserver=false;i.nginx_supported=false;i.apache_supported=false;i.site_packages=[];i.load=function(){f.get("/query/service.nginx,service.httpd",function(j){if(j["service.nginx"]&&j["service.nginx"].status){i.nginx_supported=true}if(j["service.httpd"]&&j["service.httpd"].status){i.apache_supported=true}i.has_httpserver=i.nginx_supported||i.apache_supported;if(i.has_httpserver){if(g){if(g=="nginx"&&i.nginx_supported){b.setSection("nginx")}else{if(g=="apache"&&i.apache_supported){b.setSection("apache")}else{if(g=="package"){b.setSection("package")}else{b.setSection(i.nginx_supported?"nginx":"apache")}}}}else{b.setSection(i.nginx_supported?"nginx":"apache")}}i.loaded=true;i.loadsites()});f.get("/sitepackage/getlist",function(j){if(j.code==0){i.site_packages=j.data}})};i.package_install_setting=function(j){i.curpkg=j;i.curver=j.versions[0];i.pkgver=i.curver.code;i.installpath="/var/www";$("#pkg_install_setting").modal()};i.package_version_select=function(j){i.pkgver=j.code;i.curver=j};i.selectinstallpath=function(j){i.selector_title="请选择安装目录";i.selector.onlydir=true;i.selector.onlyfile=false;i.selector.load(i.installpath);i.selector.selecthandler=function(k){$("#selector").modal("hide");i.installpath=k};$("#selector").modal()};i.package_install=function(){a.setInfo("正在检测安装目录...",true);f.post("/operation/file",{action:"listdir",path:i.installpath,showhidden:true,remember:false},function(j){if(j.code==0){a.setInfo("");if(j.data.length>0){i.confirm_title="安装确认";i.confirm_body="<p>系统检测到目录 "+i.installpath+" 下存在文件，继续安装将可能会覆盖原文件。</p><p>确认要继续安装吗？</p>";$("#confirm").modal();i.confirm=d}else{d()}}else{a.setError("安装失败！"+j.msg)}},false,true)};function d(){a.setInfo("正在请求安装文件...");f.get("/sitepackage/getdownloadtask?name="+i.curpkg.code+"&version="+i.pkgver,function(j){if(j.code==0){i.downloadurl=j.data.url;i.downloadpath=j.data.path;i.extractpath=j.data.temp;c.call(i,e,"/backend/wget","/backend/wget_"+encodeURIComponent(encodeURIComponent(i.downloadurl)),{url:i.downloadurl,path:i.downloadpath},{success:function(l){var m=i.downloadpath;var k=i.extractpath;c.call(i,e,"/backend/decompress","/backend/decompress_"+m+"_"+k,{zippath:m,despath:k},{success:function(p){var q=i.curver.core_path;var o=i.extractpath+"/"+q+"/*";var n=i.installpath;c.call(i,e,"/backend/copy","/backend/copy_"+o+"_"+n,{srcpath:o,despath:n},{success:function(r){a.setInfo("正在清理安装临时文件...");c.call(i,e,"/backend/remove","/backend/remove_"+i.extractpath,{paths:i.extractpath},function(){a.setInfo("正在设置目录权限...");c.call(i,e,"/backend/chown","/backend/chown_"+i.installpath,{paths:i.installpath,user:"apache",group:"apache",recursively:true},{success:function(s){a.setSuccess(i.curpkg.name+" v"+i.pkgver+" 安装完成！")}})},true)},error:function(r){a.setError("复制安装文件过程中出现错误，安装取消！")}})}})},error:function(k){a.setError("下载安装包过程中出现错误，安装取消！")}},false)}})}i.loadsites=function(){if(i.nginx_supported){i.loadnginx()}if(i.apache_supported){i.loadapache()}};i.loadnginx=function(){f.post("/operation/nginx",{action:"getservers"},function(j){if(j.code==0){i.servers=j.data}})};i.loadapache=function(){};i.nginx_enableserver=function(l,j,k){f.post("/operation/nginx",{action:"enableserver",ip:l,port:j,server_name:k},function(m){if(m.code==0){i.loadnginx()}})};i.nginx_disableserver=function(l,j,k){f.post("/operation/nginx",{action:"disableserver",ip:l,port:j,server_name:k},function(m){if(m.code==0){i.loadnginx()}})};i.nginx_deleteserverconfirm=function(l,j,k){i.nginx_ip=l;i.nginx_port=j;i.nginx_server_name=k;$("#nginx_deleteserverconfirm").modal()};i.nginx_deleteserver=function(){f.post("/operation/nginx",{action:"deleteserver",ip:i.nginx_ip,port:i.nginx_port,server_name:i.nginx_server_name},function(j){if(j.code==0){i.loadnginx()}})}}];var SiteNginxCtrl=["$scope","Module","$routeParams","$location","Request","Backend","Timeout",function(p,m,c,d,q,b,u){var e=c.section;var r=e=="new"?"new":"edit";var l=r=="edit"?e.substr(5):"";var f,g,s;if(r=="edit"){l=l.split("_");if(l.length==3){f=l[0];g=l[1];s=l[2]}else{if(l.length==4&&l[3]==""){f=l[0];g=l[1];s="_"}else{d.path("/site");return}}}var j="site.nginx";m.init(j,r=="new"?"新建站点（Nginx）":"编辑站点（Nginx）");p.loaded=false;p.showglobaladv=false;p.curloc=-1;p.setloc=function(v){p.curloc=v};p.action=r;var i={server_names:[],listens:[],charset:"",index:"index.html index.htm index.php",locations:[],limit_rate:"",limit_conn:"",ssl_crt:"",ssl_key:"",rewrite_enable:false,rewrite_rules:""};var n={name:"",default_name:false};var t={ip:"",port:"80",ssl:false,default_server:false};var k={urlpath:"/",engine:"static","static":{root:"/var/www/",autocreate:true,autoindex:false,rewrite_enable:false,rewrite_detect_file:true,rewrite_rules:""},fastcgi:{root:"/var/www/",autocreate:true,fastcgi_pass:"127.0.0.1:9000",rewrite_enable:false,rewrite_detect_file:true,rewrite_rules:""},proxy:{protocol:"http",host:"",realip:true,charset:"",backends:[],balance:"ip_hash",keepalive:"10",proxy_cache_enable:false,proxy_cache:"",proxy_cache_min_uses:"",proxy_cache_methods_post:false,proxy_cache_key:{schema:true,host:false,proxy_host:true,uri:true,},proxy_cache_valid:[],proxy_cache_use_stale:{error:false,timeout:false,invalid_header:false,updating:false,http_500:false,http_502:false,http_503:false,http_504:false,http_404:false},proxy_cache_lock:false,proxy_cache_lock_timeout:"5"},redirect:{url:"",type:"301",option:"keep"},error:{code:"404"}};var o={server:"",weight:"",fail_timeout:"10",max_fails:"3"};var a={code:"any",time:"1",time_unit:"h"};p.setting=angular.copy(i);p.gen_by_vpsmate=r=="new"?true:false;var h={"301_1":"rewrite ^ http://example.com$request_uri? permanent","301_2":"rewrite ^ http://example.com/ permanent","302_1":"rewrite ^ http://example.com$request_uri? redirect","302_2":"rewrite ^ http://example.com/ redirect"};p.$watch("rewrite_template",function(v){p.setting.rewrite_rules=v?h[v]:""});p.load=function(){if(r=="new"){p.loaded=true}else{p.getserver()}b.call(p,j,"/backend/yum_info","/backend/yum_info_nginx",{pkg:"nginx",repo:"installed"},{success:function(v){p.nginx_version=v.data[0].version},error:function(v){p.nginx_version=""}},true);p.loadproxycaches()};p.proxy_caches=[];p.loadproxycaches=function(){q.post("/operation/nginx",{action:"gethttpsettings",items:"proxy_cache_path[]"},function(x){if(x.code==0){var v=$.browser.msie?[""]:[];var y=x.data.proxy_cache_path;if(y){for(var w=0;w<y.length;w++){v.push(y[w].name)}}p.proxy_caches=v}},false,true)};p.getserver=function(v){q.post("/operation/nginx",{action:"getserver",ip:f,port:g,server_name:s},function(D){if(D.code==0){var F=D.data;var K=p.setting;p.gen_by_vpsmate=F._vpsmate;for(B in F.server_names){var x=F.server_names[B];K.server_names.push({name:x,default_name:x=="_"})}for(B in F.listens){var C=F.listens[B];var I=angular.copy(t);if(typeof C.ip!="undefined"){I.ip=C.ip}if(typeof C.port!="undefined"){I.port=C.port}if(typeof C.ssl!="undefined"){I.ssl=C.ssl}if(typeof C.default_server!="undefined"){I.default_server=C.default_server}K.listens.push(I)}if(F.index){K.index=F.index}if(F.charset){K.charset=F.charset}if(F.limit_rate){K.limit_rate=F.limit_rate}if(F.limit_conn){K.limit_conn=F.limit_conn}if(F.ssl_crt){K.ssl_crt=F.ssl_crt}if(F.ssl_key){K.ssl_key=F.ssl_key}if(F.rewrite_rules){K.rewrite_rules=F.rewrite_rules.join("\n");if(K.rewrite_rules){K.rewrite_enable=true}}if(F.locations){for(B in F.locations){var E=F.locations[B];var I=angular.copy(k);if(typeof E.urlpath!="undefined"){I.urlpath=E.urlpath;I.oldurlpath=I.urlpath}if(typeof E.error_code!="undefined"){I.engine="error";I.error.code=E.error_code}else{if(typeof E.fastcgi_pass!="undefined"){I.engine="fastcgi";I.fastcgi.fastcgi_pass=E.fastcgi_pass;if(E.root){I.fastcgi.root=E.root}I.fastcgi.rewrite_detect_file=E.rewrite_detect_file?true:false;if(E.rewrite_rules){I.fastcgi.rewrite_rules=E.rewrite_rules.join(";\n");if(I.fastcgi.rewrite_rules){I.fastcgi.rewrite_rules+=";";I.fastcgi.rewrite_enable=true}}}else{if(typeof E.proxy_protocol!="undefined"){I.engine="proxy";I.proxy.protocol=E.proxy_protocol;if(typeof E.proxy_host!="undefined"){I.proxy.host=E.proxy_host}if(typeof E.proxy_realip!="undefined"){I.proxy.realip=E.proxy_realip}if(typeof E.proxy_balance!="undefined"){I.proxy.balance=E.proxy_balance}if(typeof E.proxy_keepalive!="undefined"){I.proxy.keepalive=E.proxy_keepalive}for(B in E.proxy_backends){var w=E.proxy_backends[B];var G=angular.copy(o);if(typeof w.server!="undefined"){G.server=w.server}if(typeof w.weight!="undefined"){G.weight=w.weight}if(typeof w.fail_timeout!="undefined"){G.fail_timeout=w.fail_timeout}if(typeof w.max_fails!="undefined"){G.max_fails=w.max_fails}I.proxy.backends.push(G)}if(typeof E.proxy_cache!="undefined"){I.proxy.proxy_cache_enable=true;I.proxy.proxy_cache=E.proxy_cache;if(typeof E.proxy_cache_min_uses!="undefined"){I.proxy.proxy_cache_min_uses=E.proxy_cache_min_uses}if(typeof E.proxy_cache_methods!="undefined"){I.proxy.proxy_cache_methods_post=E.proxy_cache_methods=="POST"}if(typeof E.proxy_cache_key!="undefined"){var A=E.proxy_cache_key.split("$");var J=I.proxy.proxy_cache_key;for(var B=0;B<A.length;B++){if(A[B]=="schema"){J.schema=true}else{if(A[B]=="host"){J.host=true}else{if(A[B]=="proxy_host"){J.proxy_host=true}else{if(A[B]=="request_uri"){J.uri=true}}}}}}if(typeof E.proxy_cache_valid!="undefined"){var z=E.proxy_cache_valid;for(var B=0;B<z.length;B++){I.proxy.proxy_cache_valid.push({code:z[B].code,time:parseInt(z[B].time)+"",time_unit:z[B].time.substr(z[B].time.length-1),})}}if(typeof E.proxy_cache_use_stale!="undefined"){var y=E.proxy_cache_use_stale;var H=I.proxy.proxy_cache_use_stale;for(var B=0;B<y.length;B++){if(y[B]=="error"){H.error=true}else{if(y[B]=="timeout"){H.timeout=true}else{if(y[B]=="invalid_header"){H.invalid_header=true}else{if(y[B]=="updating"){H.updating=true}else{if(y[B]=="http_500"){H.http_500=true}else{if(y[B]=="http_502"){H.http_502=true}else{if(y[B]=="http_503"){H.http_503=true}else{if(y[B]=="http_504"){H.http_504=true}else{if(y[B]=="http_404"){H.http_404=true}}}}}}}}}}}if(typeof E.proxy_cache_lock!="undefined"){I.proxy.proxy_cache_lock=E.proxy_cache_lock;if(typeof E.proxy_cache_lock_timeout!="undefined"){I.proxy.proxy_cache_lock_timeout=E.proxy_cache_lock_timeout}}}}else{if(typeof E.redirect_url!="undefined"){I.engine="redirect";I.redirect.url=E.redirect_url;if(typeof E.redirect_type!="undefined"){I.redirect.type=E.redirect_type}if(typeof E.redirect_option!="undefined"){I.redirect.option=E.redirect_option}}else{if(typeof E.root!="undefined"){I.engine="static";I["static"].root=E.root;I["static"].rewrite_detect_file=E.rewrite_detect_file?true:false;if(typeof E.autoindex!="undefined"){I["static"].autoindex=E.autoindex}if(E.rewrite_rules){I["static"].rewrite_rules=E.rewrite_rules.join(";\n");if(I["static"].rewrite_rules){I["static"].rewrite_rules+=";";I["static"].rewrite_enable=true}}}}}}}if(I.proxy.backends.length==0){I.proxy.backends.push(angular.copy(o))}K.locations.push(I)}}p.curloc=0;p.loaded=true}else{u(function(){d.path("/site")},1000,j)}},false,v)};p.deleteservername=function(v){p.setting.server_names.splice(v,1)};p.addservername=function(){p.setting.server_names.push(angular.copy(n))};p.deletelisten=function(v){p.setting.listens.splice(v,1)};p.addlisten=function(){p.setting.listens.push(angular.copy(t))};p.deletelocation=function(v){p.setting.locations.splice(v,1);p.curloc--;if(p.curloc<0&&p.setting.locations.length>0){p.curloc=0}};p.addlocation=function(){var v=p.setting.locations;v.splice(p.curloc+1,0,angular.copy(k));p.proxy_addbackend(p.curloc+1);p.curloc++};p.proxy_deletebackend=function(v,w){p.setting.locations[v].proxy.backends.splice(w,1)};p.proxy_addbackend=function(v){p.setting.locations[v].proxy.backends.push(angular.copy(o));p.proxy_addvalid(v)};p.proxy_deletevalid=function(v,w){p.setting.locations[v].proxy.proxy_cache_valid.splice(w,1)};p.proxy_addvalid=function(v){p.setting.locations[v].proxy.proxy_cache_valid.push(angular.copy(a))};p.$watch("setting.server_names[0].name",function(D,x){var B=D;var v=x;var A=p.setting.locations;for(var z=0;z<A.length;z++){if(A[z].urlpath=="/"){var w=k["static"].root;var y=w+"/"+v;y=y.replace("//","/");if(A[z]["static"].root==y){var C=w+"/"+B;A[z]["static"].root=C.replace("//","/")}var w=k.fastcgi.root;var y=w+"/"+v;y=y.replace("//","/");if(A[z].fastcgi.root==y){var C=w+"/"+B;A[z].fastcgi.root=C.replace("//","/")}}}});p.urlpathchange=function(w){if(w.urlpath.length==0){w.urlpath="/"}if(w.engine=="fastcgi"&&w.fastcgi.rewrite_enable){var v=new RegExp("([\\^\\s])("+(w.oldurlpath+"/").replace("//","/").replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")","gm");w.fastcgi.rewrite_rules=w.fastcgi.rewrite_rules.replace(v,"$1"+(w.urlpath+"/").replace("//","/"));w.oldurlpath=w.urlpath}};p.selectstaticfolder=function(v){p.selector_title="请选择站点目录";p.selector.onlydir=true;p.selector.onlyfile=false;p.selector.load(p.setting.locations[v]["static"].root);p.selector.selecthandler=function(w){$("#selector").modal("hide");p.setting.locations[v]["static"].root=w};$("#selector").modal()};p.selectfastcgifolder=function(v){p.selector_title="请选择站点目录";p.selector.onlydir=true;p.selector.onlyfile=false;p.selector.load(p.setting.locations[v].fastcgi.root);p.selector.selecthandler=function(w){$("#selector").modal("hide");p.setting.locations[v].fastcgi.root=w};$("#selector").modal()};p.selectsslcrt=function(v){p.selector_title="请选择CRT文件（*.crt）";p.selector.onlydir=false;p.selector.onlyfile=true;p.selector.load("/root");p.selector.selecthandler=function(w){$("#selector").modal("hide");p.setting.ssl_crt=w};$("#selector").modal()};p.selectsslkey=function(v){p.selector_title="请选择密钥文件（*.key）";p.selector.onlydir=false;p.selector.onlyfile=true;p.selector.load("/root");p.selector.selecthandler=function(w){$("#selector").modal("hide");p.setting.ssl_key=w};$("#selector").modal()};p.addserver=function(){q.post("/operation/nginx",{action:"addserver",version:p.nginx_version,setting:angular.toJson(p.setting)},function(x){if(x.code==0){var w=p.setting;p.loaded=false;var v=(w.listens[0].ip?w.listens[0].ip:"*")+"_"+w.listens[0].port+"_"+w.server_names[0].name;u(function(){d.path("/site/nginx/edit_"+encodeURIComponent(v))},1000,j)}})};p.updateserver=function(){q.post("/operation/nginx",{action:"updateserver",ip:f,port:g,server_name:s,version:p.nginx_version,setting:angular.toJson(p.setting)},function(x){if(x.code==0){var w=p.setting;p.loaded=false;var v=(w.listens[0].ip?w.listens[0].ip:"*")+"_"+w.listens[0].port+"_"+w.server_names[0].name;u(function(){var y="/site/nginx/edit_"+encodeURIComponent(v);if(y!=d.path()){d.path(y)}else{p.restore()}},1000,j)}})};p.restore=function(){p.setting=angular.copy(i);p.getserver()};if(e=="new"){p.addservername();p.addlisten();p.addlocation()}}];