var DatabaseCtrl=["$scope","Module","$rootScope","Request","Message","Backend",function(c,g,a,f,e,b){var d="database";g.init(d,"数据库管理");c.loaded=false;var h=g.getSection();c.has_dbserver=false;c.mysql_supported=false;c.load=function(){f.get("/query/service.mysqld",function(i){if(i["service.mysqld"]&&i["service.mysqld"].status){c.mysql_supported=true}c.has_dbserver=c.mysql_supported;if(c.has_dbserver){if(h){if(h=="mysqld"&&c.mysql_supported){g.setSection("mysqld")}else{g.setSection(c.mysql_supported?"mysql":"mysql")}}else{g.setSection(c.mysql_supported?"mysql":"mysql")}}c.loaded=true})};c.validate_password=function(){c.processing=true;f.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true;c.loaddbs();c.loadusers()}c.processing=false})};c.dbloading=true;c.loaddbs=function(){c.dbloading=true;b.call(c,d,"/backend/mysql_databases","/backend/mysql_databases",{password:a.$mysql.password},{success:function(i){c.dbs=i.data;c.dbloading=false},error:function(){c.dbloading=false}})};c.userloading=true;c.loadusers=function(){c.userloading=true;b.call(c,d,"/backend/mysql_users","/backend/mysql_users",{password:a.$mysql.password},{success:function(i){c.users=i.data;c.userloading=false},error:function(){c.userloading=false}})};if(a.$mysql.password_validated){c.loaddbs();c.loadusers()}}];var DatabaseMySQLNewDBCtrl=["$scope","Module","$rootScope","$location","Request","Message","Backend",function(c,g,a,h,f,e,b){var d="database.mysql.db.new";g.init(d,"新建数据库");c.loaded=true;c.collation="utf8_general_ci";c.validate_password=function(){c.processing=true;f.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true}c.processing=false})};c.newdb=function(){c.processing=true;b.call(c,d,"/backend/mysql_create","/backend/mysql_create_"+c.dbname,{password:a.$mysql.password,dbname:c.dbname,collation:c.collation},{success:function(i){h.path("/database/mysql/db/edit/"+encodeURIComponent(c.dbname));c.processing=false},error:function(){c.processing=false}})}}];var DatabaseMySQLEditDBCtrl=["$scope","Module","$rootScope","$routeParams","$location","Request","Message","Backend",function(j,b,g,i,d,f,a,c){var h=i.section;j.dbname=decodeURIComponent(h);var e="database.mysql.db.edit";b.init(e,"管理数据库 "+j.dbname);b.initSection("users");j.loaded=true;j.validate_password=function(){j.processing=true;f.post("/operation/mysql",{action:"checkpwd",password:g.$mysql.password},function(k){if(k.code==0){g.$mysql.password_validated=true;j.loaddbinfo()}j.processing=false})};j.dbloading=true;j.loaddbinfo=function(){j.dbloading=true;c.call(j,e,"/backend/mysql_dbinfo","/backend/mysql_dbinfo_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},{success:function(k){j.dbinfo=k.data;j.dbloading=false;j.loadusers()},error:function(){j.dbloading=false}})};j.userloading=true;j.loadusers=function(){j.userloading=true;c.call(j,e,"/backend/mysql_users","/backend/mysql_users_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},{success:function(k){j.users=k.data;j.userloading=false},error:function(){j.userloading=false}})};j.setcollation=function(){j.processing=true;f.post("/operation/mysql",{action:"alter_database",password:g.$mysql.password,dbname:j.dbname,collation:j.dbinfo.collation},function(){j.processing=false})};j.rename=function(){j.processing=true;c.call(j,e,"/backend/mysql_rename","/backend/mysql_rename_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname,newname:j.dbinfo.name},{success:function(k){d.path("/database/mysql/db/edit/"+encodeURIComponent(j.dbinfo.name));j.processing=false},error:function(){j.processing=false}})};j.selectexportfolder=function(){j.selector.onlydir=true;j.selector.onlyfile=false;j.selector.load(j.exportpath?j.exportpath:"/root");j.selector.selecthandler=function(k){$("#selector").modal("hide");j.exportpath=k};$("#selector").modal()};j.exportdb=function(){j.processing=true;c.call(j,e,"/backend/mysql_export","/backend/mysql_export_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname,path:j.exportpath},function(k){j.processing=false})};j.dropdb=function(){j.processing=true;c.call(j,e,"/backend/mysql_drop","/backend/mysql_drop_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},function(k){if(k.code==0){d.path("/database");d.search("s","mysql")}j.processing=false})};if(g.$mysql.password_validated){j.loaddbinfo()}}];var DatabaseMySQLNewUserCtrl=["$scope","Module","$rootScope","$location","Request","Message","Backend",function(c,g,a,h,f,e,b){var d="database.mysql.user.new";g.init(d,"添加新用户");c.loaded=true;c.dbname=g.getParam("dbname");c.validate_password=function(){c.processing=true;f.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true}c.processing=false})};c.newuser=function(){if(!c.emptypassword){if(c.password!=c.passwordc){e.setError("新密码和确认密码不一致！");return}}var i=c.user+"@"+c.host;c.processing=true;b.call(c,d,"/backend/mysql_createuser","/backend/mysql_createuser_"+i,{password:a.$mysql.password,user:c.user,host:c.host,pwd:c.emptypassword?"":c.password},{success:function(j){h.path("/database/mysql/user/edit/"+encodeURIComponent(i));if(c.dbname){h.search("dbname",c.dbname)}c.processing=false},error:function(){c.processing=false}})};c.genpassword=function(){var n="ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var o=16;var m="";var j=0;var p=0;for(var l=0;l<o;l++){if((Math.floor(Math.random()*2)==0)&&p<3||j>=5){var k=Math.floor(Math.random()*10);m+=k;p+=1}else{var k=Math.floor(Math.random()*n.length);m+=n.substring(k,k+1);j+=1}}c.randpassword=c.password=c.passwordc=m}}];var DatabaseMySQLEditUserCtrl=["$scope","Module","$rootScope","$routeParams","$location","Request","Message","Backend",function(k,b,h,j,d,g,a,c){var i=j.section;k.username=decodeURIComponent(i);var e=k.username.split("@");k.user=e[0];k.host=e[1];var f="database.mysql.user.edit";b.init(f,"管理用户 "+k.username);b.initSection("privs");k.loaded=true;k.validate_password=function(){k.processing=true;g.post("/operation/mysql",{action:"checkpwd",password:h.$mysql.password},function(m){if(m.code==0){h.$mysql.password_validated=true;k.loadprivs();k.loaddbs()}k.processing=false})};k.privsloading=true;k.loadprivs=function(){k.privsloading=true;c.call(k,f,"/backend/mysql_userprivs","/backend/mysql_userprivs_"+k.username,{password:h.$mysql.password,username:k.username},{success:function(m){k.privs=m.data;k.privsloading=false;var o=b.getParam("dbname");var n=b.getParam("privtype");if(o){k.privs_dbname=o;k.editprivs(false,n)}},error:function(){k.privsloading=false}})};k.$watch("selectall",function(m){angular.forEach(k.curprivs,function(n,o){if(o.indexOf("_priv")>0){k.curprivs[o]=m?"Y":"N"}})});var l={Select_priv:"N",Insert_priv:"N",Update_priv:"N",Delete_priv:"N",Create_priv:"N",Alter_priv:"N",Index_priv:"N",Drop_priv:"N",Create_tmp_table_priv:"N",Show_view_priv:"N",Create_routine_priv:"N",Alter_routine_priv:"N",Execute_priv:"N",Create_view_priv:"N",Event_priv:"N",Trigger_priv:"N",Grant_priv:"N",Lock_tables_priv:"N",References_priv:"N"};k.editprivs=function(p,o){if(o=="global"){k.orgprivs=k.privs.global;k.curprivs=angular.copy(k.privs.global)}else{if(!p){if(!k.privs_dbname){return}var n=false;for(var m=0;m<k.privs.bydb.length;m++){if(k.privs.bydb[m].Db==k.privs_dbname){k.orgprivs=k.privs.bydb[m];k.curprivs=angular.copy(k.privs.bydb[m]);n=true;break}}if(!n){k.orgprivs=null;k.curprivs=angular.copy(l);k.curprivs.Db=k.privs_dbname;k.curprivs.flag="new"}}else{k.orgprivs=p;k.curprivs=angular.copy(p)}}if(!k.curprivs.Db){k.privsedit_title="设置 "+k.username+" 的全局权限"}else{k.privsedit_title="设置 "+k.username+" 在数据库 "+k.curprivs.Db+" 的权限"}$("#privsedit").modal()};k.updateprivs=function(){c.call(k,f,"/backend/mysql_updateuserprivs","/backend/mysql_updateuserprivs_"+encodeURIComponent(k.username+(k.curprivs.Db?"_"+k.curprivs.Db:"")),{password:h.$mysql.password,username:k.username,privs:angular.toJson(k.curprivs),dbname:k.curprivs.Db},{success:function(m){if(k.curprivs.flag=="new"){k.privs.bydb.push(k.curprivs)}else{angular.copy(k.curprivs,k.orgprivs)}var n=b.getParam("dbname");if(n){d.path("/database/mysql/db/edit/"+encodeURIComponent(n))}}})};k.loaddbs=function(){k.dbloading=true;c.call(k,f,"/backend/mysql_databases","/backend/mysql_databases",{password:h.$mysql.password},{success:function(m){k.dbs=m.data}},true)};k.setpassword=function(){if(!k.emptypassword){if(k.newpassword!=k.newpasswordc){a.setError("新密码和确认密码不一致！");return}}k.processing=true;c.call(k,f,"/backend/mysql_setuserpassword","/backend/mysql_setuserpassword_"+k.username,{password:h.$mysql.password,username:k.username,pwd:k.emptypassword?"":k.newpassword},{success:function(m){k.processing=false},error:function(){k.processing=false}})};k.dropuser=function(){k.processing=true;c.call(k,f,"/backend/mysql_dropuser","/backend/mysql_dropuser_"+k.username,{password:h.$mysql.password,username:k.username},function(m){if(m.code==0){d.path("/database");d.search("s","mysql")}k.processing=false})};if(h.$mysql.password_validated){k.loadprivs();k.loaddbs()}}];